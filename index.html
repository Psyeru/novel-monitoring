<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #6200ea; --bg: #f3f4f6; --surface: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", Roboto, sans-serif; background: var(--bg); color: #1f2937; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: var(--surface); padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
        .input-group { display: flex; gap: 12px; margin-bottom: 16px; }
        input { flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; }
        input:focus { outline: none; border-color: var(--primary); }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; }
        button:disabled { background: #d1d5db; cursor: not-allowed; }

        #status-msg { text-align: center; font-weight: 600; color: var(--primary); margin: 16px 0; min-height: 24px; }
        .error-box { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 12px; display: none; }

        /* ì•„ì½”ë””ì–¸ ìŠ¤íƒ€ì¼ */
        details { background: white; margin-bottom: 15px; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        summary { padding: 16px 20px; cursor: pointer; font-weight: 700; font-size: 16px; display: flex; align-items: center; justify-content: space-between; user-select: none; transition: background 0.2s; }
        summary:hover { background: #f9fafb; }
        summary::-webkit-details-marker { display: none; } /* ê¸°ë³¸ ì‚¼ê°í˜• ìˆ¨ê¹€ */
        
        /* ì¹´í…Œê³ ë¦¬ë³„ í—¤ë” ìƒ‰ìƒ */
        .header-issue { color: #dc2626; border-left: 5px solid #dc2626; }
        .header-novel { color: #2563eb; border-left: 5px solid #2563eb; }
        .header-chat { color: #4b5563; border-left: 5px solid #9ca3af; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .list-content { border-top: 1px solid #f3f4f6; }
        .item-row { display: flex; padding: 12px 20px; border-bottom: 1px solid #f3f4f6; align-items: center; font-size: 14px; }
        .item-row:last-child { border-bottom: none; }
        .item-row:hover { background: #f8fafc; }
        
        .item-no { color: #9ca3af; width: 80px; font-size: 12px; }
        .item-link { flex: 1; text-decoration: none; color: #1f2937; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 15px; }
        .item-link:hover { text-decoration: underline; color: var(--primary); }
        .item-reason { color: #6b7280; font-size: 12px; background: #f3f4f6; padding: 4px 8px; border-radius: 6px; }

        /* ì¹´ìš´íŠ¸ ë±ƒì§€ */
        .count-badge { background: #eee; padding: 4px 10px; border-radius: 20px; font-size: 12px; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">âš¡ ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸</h2>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744142)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex: 0.4;">
        </div>
        <button id="btnRun" onclick="startEngine()">ë¶„ì„ ì‹œì‘</button>
        <div id="errorBox" class="error-box"></div>
    </div>

    <div id="status-msg">ì¤€ë¹„ ì™„ë£Œ</div>

    <div id="resultArea" style="display:none;">
        
        <details open>
            <summary class="header-issue">
                <span>ğŸš¨ ì´ìŠˆ / ë¶ˆíƒ</span>
                <span class="count-badge" id="cnt-issue">0ê±´</span>
            </summary>
            <div class="list-content" id="list-issue"></div>
        </details>

        <details open>
            <summary class="header-novel">
                <span>ğŸ“– ì†Œì„¤ / ì¶”ì²œ / ë¦¬ë·°</span>
                <span class="count-badge" id="cnt-novel">0ê±´</span>
            </summary>
            <div class="list-content" id="list-novel"></div>
        </details>

        <details>
            <summary class="header-chat">
                <span>ğŸ’¬ ì¡ë‹´ / ê¸°íƒ€</span>
                <span class="count-badge" id="cnt-chat">0ê±´</span>
            </summary>
            <div class="list-content" id="list-chat"></div>
        </details>

    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startEngine() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-msg'),
            error: document.getElementById('errorBox'),
            resultArea: document.getElementById('resultArea'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        // ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.error.style.display = 'none';
        ui.resultArea.style.display = 'none';
        Object.values(ui.lists).forEach(el => el.innerHTML = '');
        ui.status.innerText = "ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";

        try {
            // 1. ë°ì´í„° ìˆ˜ì§‘ (1í˜ì´ì§€ í†µì§¸ë¡œ)
            const target = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=1`;
            const resp = await fetch(PROXY_URL + encodeURIComponent(target));
            if(!resp.ok) throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
            
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
            
            let posts = [];
            const minNo = startNo - count;

            rows.forEach(row => {
                const numNode = row.querySelector('.gall_num');
                const titleNode = row.querySelector('.gall_tit a');
                
                if(numNode && titleNode) {
                    const no = parseInt(numNode.innerText.trim());
                    const title = titleNode.innerText.trim();
                    // ë²”ìœ„ í•„í„°ë§: (ì‹œì‘ë²ˆí˜¸ - ê°œìˆ˜) < no <= ì‹œì‘ë²ˆí˜¸
                    if(!isNaN(no) && no <= startNo && no > minNo) {
                        posts.push({ no, title });
                    }
                }
            });

            if(posts.length === 0) throw new Error("í•´ë‹¹ ë²”ìœ„ì˜ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            // 2. AI ë¶„ì„ (Gemini 2.5 Flash)
            ui.status.innerText = `ğŸ§  Gemini 2.5 Flash ë¶„ì„ ì¤‘ (${posts.length}ê±´)...`;

            const MODEL_NAME = "gemini-2.5-flash"; 
            const prompt = `
            Analyze these titles.
            Classify into: 'issue' (Controversy, Bug, Complaint), 'novel' (Review, Rec, Story), 'chat' (General).
            Provide short Korean reason.
            JSON Only: {"results": { "POST_ID": {"cat": "code", "reason": "text"} }}
            
            Titles:
            ${posts.map(p => `${p.no}: ${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            if(aiData.error) throw new Error(aiData.error.message);

            const rawText = aiData.candidates[0].content.parts[0].text;
            const resultData = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // 3. ê²°ê³¼ ë¶„ë¥˜ ë° ë Œë”ë§
            // ë²ˆí˜¸ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            posts.sort((a, b) => b.no - a.no);

            let counts = { issue: 0, novel: 0, chat: 0 };

            posts.forEach(p => {
                const info = resultData.results[p.no] || { cat: 'chat', reason: '-' };
                const cat = info.cat; // issue, novel, chat
                
                // ì¹´ìš´íŠ¸ ì¦ê°€
                if(counts[cat] !== undefined) counts[cat]++;
                else { counts['chat']++; } // ì˜ˆì™¸ì²˜ë¦¬ëŠ” ì¡ë‹´ìœ¼ë¡œ

                // HTML ìƒì„±
                const item = document.createElement('div');
                item.className = 'item-row';
                item.innerHTML = `
                    <span class="item-no">${p.no}</span>
                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                    <span class="item-reason">${info.reason}</span>
                `;

                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ë°•ìŠ¤ì— ë„£ê¸°
                if(ui.lists[cat]) ui.lists[cat].appendChild(item);
                else ui.lists['chat'].appendChild(item);
            });

            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            ui.cnts.issue.innerText = `${counts.issue}ê±´`;
            ui.cnts.novel.innerText = `${counts.novel}ê±´`;
            ui.cnts.chat.innerText = `${counts.chat}ê±´`;

            ui.resultArea.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";

        } catch (e) {
            console.error(e);
            ui.status.innerText = "âŒ ì¤‘ë‹¨ë¨";
            ui.error.innerHTML = `ì˜¤ë¥˜: ${e.message}`;
            ui.error.style.display = 'block';
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
