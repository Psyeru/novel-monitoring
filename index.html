<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¥´ì†Œì„¤ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f6fa; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #5a2df2; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        #log { margin-top: 20px; font-size: 13px; max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .result-card { border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; }
        .tag-site { color: #d32f2f; font-weight: bold; }
        .tag-novel { color: #5a2df2; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h2>
    <input type="text" id="apiKey" placeholder="Gemini API Key ì…ë ¥">
    <input type="number" id="lastNo" placeholder="ì‹œì‘ ê²Œì‹œë¬¼ ë²ˆí˜¸ (ì˜ˆ: 11744037)">
    <input type="number" id="count" placeholder="ê²€ì‚¬í•  ê°œìˆ˜ (ì˜ˆ: 20)" value="10">
    <button id="startBtn" onclick="run()">ë¶„ì„ ì‹œì‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <div id="log"></div>
    <div id="results"></div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function run() {
        const key = document.getElementById('apiKey').value;
        const lastNo = parseInt(document.getElementById('lastNo').value);
        const count = parseInt(document.getElementById('count').value);
        const logDiv = document.getElementById('log');
        const resDiv = document.getElementById('results');
        const btn = document.getElementById('startBtn');

        if(!key || !lastNo) return alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

        btn.disabled = true;
        logDiv.innerHTML = "";
        resDiv.innerHTML = "<h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>";

        let posts = [];
        
        // 1. ë°ì´í„° ìˆ˜ì§‘ ë‹¨ê³„
        for(let i = 0; i < count; i++) {
            const currentNo = lastNo - i;
            document.getElementById('status').innerText = `ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i+1}/${count})`;
            
            try {
                const target = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${currentNo}`;
                const res = await fetch(PROXY_URL + encodeURIComponent(target));
                const html = await res.text();
                
                if (html.includes("í•´ë‹¹ ê²Œì‹œê¸€ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) {
                    logDiv.innerHTML += `<div>âš ï¸ ${currentNo}ë²ˆ: ì‚­ì œëœ ê¸€ ê±´ë„ˆëœ€</div>`;
                    continue;
                }

                const doc = new DOMParser().parseFromString(html, 'text/html');
                const title = doc.querySelector('.title_subject')?.innerText;
                
                if(title) {
                    posts.push({ id: currentNo, title });
                }
            } catch(e) { 
                logDiv.innerHTML += `<div>âŒ ${currentNo}ë²ˆ: ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨</div>`;
            }
        }

        // 2. AI ë¶„ì„ ë‹¨ê³„ (ìµœì‹  ëª¨ë¸ ì ìš© + ì•ˆì •ì ì¸ íŒŒì‹±)
        document.getElementById('status').innerText = "AI ë¶„ì„ ì¤‘...";
        for (let i = 0; i < posts.length; i += 10) {
            const batch = posts.slice(i, i + 10);
            
            // ëª¨ë¸ëª…ì„ 'gemini-1.5-flash'ë¡œ ë³€ê²½ (ë” ë¹ ë¥´ê³  ì •í™•í•¨)
            const model = "gemini-1.5-flash"; 
            const prompt = `Return a JSON object only. Categorize these titles as 'site' (platform issues/news) or 'novel' (content/recs).
            Example format: {"123": "site", "456": "novel"}
            Titles:
            ${batch.map(p => `${p.id}: ${p.title}`).join('\n')}`;

            try {
                const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await aiRes.json();
                
                // ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
                if (data.error) {
                    throw new Error(data.error.message);
                }

                let aiText = data.candidates[0].content.parts[0].text;
                // JSONë§Œ ë‚¨ê¸°ê¸° ìœ„í•´ ì •ê·œì‹ìœ¼ë¡œ ì •ì œ
                const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");
                
                const resultJson = JSON.parse(jsonMatch[0]);

                batch.forEach(p => {
                    const type = resultJson[p.id] || "novel"; // ê¸°ë³¸ê°’ novel
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <span>[${p.id}] ${p.title.substring(0, 25)}</span>
                        <span class="tag-${type}">${type.toUpperCase()}</span>
                    `;
                    resDiv.appendChild(card);
                });
            } catch(e) { 
                console.error("AI ë¶„ì„ ì—ëŸ¬:", e); 
                logDiv.innerHTML += `<div style="color:red;">âŒ ë¶„ì„ ì—ëŸ¬: ${e.message}</div>`;
            }
        }

        document.getElementById('status').innerText = "ë¶„ì„ ì™„ë£Œ!";
        btn.disabled = false;
    }
</script>
</body>
</html>
