<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨í”¼ì•„ ì‹¬ì¸µ ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f4f6f8; --white: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-box { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }

        #status { text-align: center; margin: 15px 0; font-weight: 600; color: var(--primary); min-height: 24px; }

        /* ì•„ì½”ë””ì–¸ UI */
        details { background: white; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; overflow: hidden; }
        summary { padding: 15px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; background: #fff; user-select: none; }
        summary:hover { background: #f9f9f9; }

        /* ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
        .head-issue { border-left: 5px solid #e53e3e; color: #c53030; } /* ì´ìŠˆ */
        .head-novel { border-left: 5px solid #3182ce; color: #2b6cb0; } /* ì†Œì„¤ */
        .head-chat { border-left: 5px solid #a0aec0; color: #4a5568; } /* ì¡ë‹´ */

        .cnt { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #555; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .item { padding: 12px 15px; border-top: 1px solid #f0f0f0; display: flex; align-items: center; font-size: 13px; }
        .item:hover { background: #fafafa; }
        .item-no { width: 80px; color: #999; font-size: 12px; }
        .item-link { flex: 1; text-decoration: none; color: #333; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .item-link:hover { text-decoration: underline; color: var(--primary); }
        .item-reason { font-size: 11px; color: #666; background: #f0f0f0; padding: 3px 6px; border-radius: 4px; white-space: nowrap; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-bottom:20px;">âš¡ ë…¸ë²¨í”¼ì•„ ì‹¬ì¸µ ë¶„ì„ê¸°</h2>

    <div class="control-box">
        <div class="input-row">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-row">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744200)">
            <input type="number" id="count" value="20" placeholder="ê°œìˆ˜ (ìµœëŒ€ 30)" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startDeepScan()">ğŸ” ë³¸ë¬¸ í¬í•¨ ì •ë°€ ë¶„ì„ ì‹œì‘</button>
    </div>

    <div id="status">ì¤€ë¹„ ì™„ë£Œ</div>

    <div id="result-area" style="display:none;">
        <details open>
            <summary class="head-issue">
                <span>ğŸš¨ ë…¸ë²¨í”¼ì•„ ë¶ˆë§Œ/ì´ìŠˆ</span>
                <span class="cnt" id="cnt-issue">0</span>
            </summary>
            <div id="list-issue"></div>
        </details>

        <details open>
            <summary class="head-novel">
                <span>ğŸ“– ì†Œì„¤ ê°ìƒ/ì¶”ì²œ</span>
                <span class="cnt" id="cnt-novel">0</span>
            </summary>
            <div id="list-novel"></div>
        </details>

        <details>
            <summary class="head-chat">
                <span>ğŸ’¬ ì¼ë°˜ ì¡ë‹´</span>
                <span class="cnt" id="cnt-chat">0</span>
            </summary>
            <div id="list-chat"></div>
        </details>
    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startDeepScan() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status'),
            result: document.getElementById('result-area'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.result.style.display = 'none';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');

        try {
            // 1. ë³‘ë ¬ ë°ì´í„° ìˆ˜ì§‘ (ë³¸ë¬¸ í¬í•¨)
            ui.status.innerText = `ğŸ“¡ ê²Œì‹œë¬¼ ${count}ê°œ ë³¸ë¬¸ ìˆ˜ì§‘ ì¤‘...`;

            // ìš”ì²­í•  ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ ìƒì„± (Start ~ Start-count)
            const targetIds = Array.from({length: count}, (_, i) => startNo - i);

            // Promise.allë¡œ ë™ì‹œì— ê¸ì–´ì˜´ (ë³¸ë¬¸ ìˆ˜ì§‘ ì†ë„ ìµœì í™”)
            const fetchPromises = targetIds.map(async (no) => {
                try {
                    const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                    const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                    const html = await resp.text();
                    
                    // ì‚­ì œëœ ê¸€ ì²´í¬
                    if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const title = doc.querySelector('.title_subject')?.innerText.trim();
                    // ë³¸ë¬¸ ì¶”ì¶œ (ê¸€ ë‚´ìš©)
                    const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 300) || ""; // 300ìë§Œ ëŠìŒ

                    if(title) return { no, title, body };
                    return null;
                } catch(e) { return null; }
            });

            const rawResults = await Promise.all(fetchPromises);
            const posts = rawResults.filter(p => p !== null); // null ì œê±°

            if(posts.length === 0) throw new Error("ìˆ˜ì§‘ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜).");

            // 2. AI ì •ë°€ ë¶„ì„ (Gemini 2.5 Flash)
            ui.status.innerText = `ğŸ§  ë³¸ë¬¸ ê¸°ë°˜ ì •ë°€ ë¶„ì„ ì¤‘ (${posts.length}ê±´)...`;

            const MODEL_NAME = "gemini-2.5-flash"; 
            
            // í”„ë¡¬í”„íŠ¸: 'ì´ìŠˆ'ì˜ ì •ì˜ë¥¼ ë…¸ë²¨í”¼ì•„ ê´€ë ¨ìœ¼ë¡œ í•œì • + ë³¸ë¬¸(Body) ì°¸ê³  ì§€ì‹œ
            const prompt = `
            Analyze these community posts (Title + Body text).
            
            [Classification Rules]
            1. 'issue': STRICTLY for complaints about 'Novelpia' (Platform errors, System bugs, Billing, Company policy, Swearing at the site). If the subject is missing in the title, check the Body.
            2. 'novel': Novel reviews, recommendations, or discussing story content.
            3. 'chat': General chat, fights between users, or other topics not related to Novelpia platform issues.

            [Output Format]
            JSON Only: {"results": {"ID": {"cat": "issue/novel/chat", "reason": "Short Korean reason"}}}

            [Data]
            ${posts.map(p => `ID:${p.no} | Title:${p.title} | Body:${p.body.replace(/\n/g, ' ')}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            if(aiData.error) throw new Error(aiData.error.message);

            const rawText = aiData.candidates[0].content.parts[0].text;
            const resData = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // 3. ê²°ê³¼ ë°°ì¹˜
            let counts = { issue: 0, novel: 0, chat: 0 };

            // ìˆœì„œ ë³´ì¥ì„ ìœ„í•´ posts ë°°ì—´ ìˆœíšŒ
            posts.forEach(p => {
                const info = resData.results[p.no] || { cat: 'chat', reason: 'ë¶„ì„ë¶ˆê°€' };
                let category = info.cat;
                if(!counts.hasOwnProperty(category)) category = 'chat';

                counts[category]++;

                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <span class="item-no">${p.no}</span>
                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                    <span class="item-reason">${info.reason}</span>
                `;
                
                ui.lists[category].appendChild(div);
            });

            // ì¹´ìš´íŠ¸ ì ìš©
            ui.cnts.issue.innerText = counts.issue;
            ui.cnts.novel.innerText = counts.novel;
            ui.cnts.chat.innerText = counts.chat;

            ui.result.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ";

        } catch (e) {
            console.error(e);
            ui.status.innerText = `âŒ ì˜¤ë¥˜: ${e.message}`;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
