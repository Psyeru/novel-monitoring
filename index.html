<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        /* ê¹”ë”í•œ ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ */
        :root { --primary: #5a2df2; --bg: #f4f7fa; --surface: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* í—¤ë” ì„¹ì…˜ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; color: #1f2937; display: flex; align-items: center; gap: 10px; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-box { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        input { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; flex: 1; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        button:hover { background: #4c24cc; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* ìƒíƒœ ë°” */
        #status-bar { margin-bottom: 15px; font-size: 14px; font-weight: 600; color: var(--primary); height: 20px; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; display: none; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); text-align: center; }
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #6b7280; }
        .card .value { font-size: 28px; font-weight: 800; color: #111; }
        .card.issue .value { color: #ef4444; }

        /* ë¦¬í¬íŠ¸ í…Œì´ë¸” */
        .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; padding: 15px; text-align: left; font-weight: 600; color: #4b5563; border-bottom: 1px solid #e5e7eb; }
        td { padding: 15px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        tr:hover { background: #f9fafb; }
        
        /* ë±ƒì§€ ë””ìì¸ */
        .badge { padding: 6px 10px; border-radius: 6px; font-weight: 700; font-size: 12px; }
        .bg-issue { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .bg-novel { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .bg-info { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .bg-chat { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }

        .ai-comment { font-size: 13px; color: #6b7280; margin-left: 8px; font-style: italic; }
        .post-link { text-decoration: none; color: #1f2937; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px; }
        .post-link:hover { color: var(--primary); text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ğŸ“Š ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°</h2>
    </header>

    <div class="control-box">
        <input type="password" id="apiKey" placeholder="Gemini API Key">
        <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744085)">
        <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="max-width: 80px;">
        <button id="btnRun" onclick="startAnalysis()">ë¶„ì„ ì‹œì‘</button>
    </div>

    <div id="status-bar">ì¤€ë¹„ ì™„ë£Œ</div>

    <div class="summary-grid" id="summaryPanel">
        <div class="card">
            <h3>ë¶„ì„ëœ ê²Œì‹œë¬¼</h3>
            <div class="value" id="valTotal">-</div>
        </div>
        <div class="card issue">
            <h3>ë°œê²¬ëœ ì´ìŠˆ</h3>
            <div class="value" id="valIssue">-</div>
        </div>
        <div class="card">
            <h3>ì£¼ìš” í‚¤ì›Œë“œ</h3>
            <div class="value" id="valKeyword" style="font-size: 16px; display:flex; align-items:center; justify-content:center; height: 34px;">-</div>
        </div>
    </div>

    <div class="table-container" id="reportPanel">
        <table>
            <thead>
                <tr>
                    <th width="10%">ë²ˆí˜¸</th>
                    <th width="15%">ë¶„ë¥˜</th>
                    <th width="45%">ì œëª©</th>
                    <th width="30%">AI ì½”ë©˜íŠ¸</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. í”„ë¡ì‹œ ì„¤ì • (ì‚¬ìš©ìë‹˜ì˜ ì›Œì»¤ ì£¼ì†Œ)
    const PROXY_BASE = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startAnalysis() {
        const key = document.getElementById('apiKey').value;
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-bar'),
            summary: document.getElementById('summaryPanel'),
            report: document.getElementById('reportPanel'),
            tbody: document.getElementById('resultBody'),
            vTotal: document.getElementById('valTotal'),
            vIssue: document.getElementById('valIssue'),
            vKeyword: document.getElementById('valKeyword')
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // UI ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.summary.style.display = 'none';
        ui.report.style.display = 'none';
        ui.tbody.innerHTML = '';
        ui.status.innerText = "ğŸš€ ë°ì´í„° ê³ ì† ìˆ˜ì§‘ ì¤‘ (ë¦¬ìŠ¤íŠ¸ ìŠ¤ìº”)...";

        try {
            // 2. [ì†ë„ í˜ì‹ ] ê²Œì‹œê¸€ í•˜ë‚˜ì”© ë§ê³ , 'ëª©ë¡ í˜ì´ì§€'ë¥¼ í†µì§¸ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            // 1í˜ì´ì§€ì— 50ê°œ ê¸€ì´ ìˆìœ¼ë¯€ë¡œ, ìš”ì²­ 1ë²ˆìœ¼ë¡œ 50ê°œ í™•ë³´ ê°€ëŠ¥.
            const targetUrl = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=1`;
            const proxyUrl = PROXY_BASE + encodeURIComponent(targetUrl);
            
            const resp = await fetch(proxyUrl);
            const html = await resp.text();
            
            // 3. HTML íŒŒì‹± (ë¦¬ìŠ¤íŠ¸ì—ì„œ ë²ˆí˜¸ì™€ ì œëª© ì¶”ì¶œ)
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
            
            let collectedPosts = [];
            
            rows.forEach(row => {
                const numCell = row.querySelector('.gall_num');
                const titleCell = row.querySelector('.gall_tit a');
                
                if (numCell && titleCell) {
                    const no = parseInt(numCell.innerText);
                    const title = titleCell.innerText.trim();
                    
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë²ˆí˜¸ë¶€í„° ì•„ë˜ë¡œ 'count' ê°œìˆ˜ë§Œí¼ ìˆ˜ì§‘
                    if (!isNaN(no) && no <= startNo) {
                        collectedPosts.push({ no, title });
                    }
                }
            });

            // ê°œìˆ˜ ì œí•œ ìë¥´ê¸°
            collectedPosts = collectedPosts.slice(0, count);

            if (collectedPosts.length === 0) throw new Error("í•´ë‹¹ ë²”ìœ„ì˜ ê²Œì‹œë¬¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í˜ì´ì§€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ì„ ìˆ˜ ìˆìŒ)");

            // 4. AI ë¶„ì„ (Gemini 1.5 Flash ì‚¬ìš© - ì•ˆì •ì„±/ì†ë„ ìµœì )
            ui.status.innerText = `ğŸ§  AI ì •ë°€ ë¶„ì„ ì¤‘ (${collectedPosts.length}ê±´)...`;

            const MODEL = "gemini-1.5-flash"; // í˜„ì¬ APIì—ì„œ ì—ëŸ¬ ì—†ì´ ê°€ì¥ ë¹ ë¦„
            const prompt = `
            You are a professional monitoring analyst.
            Analyze these community post titles.
            
            Task 1: Classify each post into: 'issue' (Controversy, Bug, Complaint), 'novel' (Story, Recs), 'info' (News), 'chat' (General).
            Task 2: Provide a very short reason (Korean) like "ì‘í’ˆ ì¶”ì²œ", "í”Œë«í¼ ì˜¤ë¥˜".
            Task 3: Pick 1 main keyword describing the overall vibe.

            Output JSON only:
            {
                "keyword": "Main Vibe Keyword",
                "results": {
                    "POST_NUMBER": {"cat": "code", "reason": "text"}
                }
            }

            Titles:
            ${collectedPosts.map(p => `${p.no}: ${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            if (aiData.error) throw new Error(aiData.error.message);

            // JSON íŒŒì‹± (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
            const rawText = aiData.candidates[0].content.parts[0].text;
            const jsonStr = rawText.match(/\{[\s\S]*\}/)[0]; 
            const resultData = JSON.parse(jsonStr);

            // 5. ê²°ê³¼ í™”ë©´ ì¶œë ¥ (ë¦¬í¬íŠ¸ ìŠ¤íƒ€ì¼)
            let issueCount = 0;
            
            collectedPosts.forEach(post => {
                const info = resultData.results[post.no] || { cat: 'chat', reason: '-' };
                if (info.cat === 'issue') issueCount++;

                const tr = document.createElement('tr');
                
                // ë±ƒì§€ ìŠ¤íƒ€ì¼ ë§¤í•‘
                const badges = {
                    'issue': '<span class="badge bg-issue">ğŸš¨ ì´ìŠˆ</span>',
                    'novel': '<span class="badge bg-novel">ğŸ“– ì†Œì„¤</span>',
                    'info': '<span class="badge bg-info">ğŸ“¢ ì •ë³´</span>',
                    'chat': '<span class="badge bg-chat">ğŸ’¬ ì¡ë‹´</span>'
                };

                tr.innerHTML = `
                    <td style="color:#888;">${post.no}</td>
                    <td>${badges[info.cat] || badges['chat']}</td>
                    <td><a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${post.no}" target="_blank" class="post-link">${post.title}</a></td>
                    <td style="color:#555; font-size:13px;">${info.reason}</td>
                `;
                ui.tbody.appendChild(tr);
            });

            // ìš”ì•½ íŒ¨ë„ ì—…ë°ì´íŠ¸
            ui.vTotal.innerText = collectedPosts.length;
            ui.vIssue.innerText = issueCount;
            ui.vKeyword.innerText = resultData.keyword || "ë°ì´í„° ì—†ìŒ";

            ui.summary.style.display = 'grid';
            ui.report.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ";

        } catch (e) {
            console.error(e);
            ui.status.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜: ${e.message}</span>`;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>

</body>
</html>
