<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ë”¥ ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #6200ea; --bg: #f4f6f8; --surface: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", Roboto, sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        input:focus { outline: none; border-color: var(--primary); }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #cbd5e1; cursor: wait; }

        #status-msg { text-align: center; font-size: 14px; color: var(--primary); font-weight: 600; margin: 10px 0; min-height: 20px; }
        
        /* ì•„ì½”ë””ì–¸ UI */
        details { background: white; margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        summary { padding: 12px 16px; cursor: pointer; font-weight: 700; font-size: 15px; display: flex; justify-content: space-between; align-items: center; background: #fff; transition: background 0.2s; user-select: none; }
        summary:hover { background: #f9f9f9; }
        
        /* ì¹´í…Œê³ ë¦¬ë³„ í—¤ë” ìƒ‰ìƒ */
        .head-issue { border-left: 4px solid #ef4444; color: #b91c1c; }
        .head-novel { border-left: 4px solid #3b82f6; color: #1d4ed8; }
        .head-chat { border-left: 4px solid #9ca3af; color: #4b5563; }
        
        /* ë±ƒì§€ */
        .cnt-badge { font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 12px; color: #555; font-weight: normal; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .list-box { border-top: 1px solid #f0f0f0; }
        .item { display: flex; padding: 10px 16px; border-bottom: 1px solid #f5f5f5; align-items: center; font-size: 13px; }
        .item:last-child { border-bottom: none; }
        .item-no { color: #aaa; width: 70px; font-size: 12px; }
        .item-link { flex: 1; text-decoration: none; color: #333; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .item-link:hover { text-decoration: underline; color: var(--primary); }
        .item-reason { background: #f8f9fa; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin:0 0 20px 0;">âš¡ ê°¤ëŸ¬ë¦¬ ë”¥ ëª¨ë‹ˆí„°</h2>

    <div class="control-panel">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744000)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startProcess()">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
    </div>

    <div id="status-msg">ì¤€ë¹„ ì™„ë£Œ</div>

    <div id="result-area" style="display:none;">
        <details open>
            <summary class="head-issue">
                <span>ğŸš¨ ì´ìŠˆ / ë¶ˆíƒ</span>
                <span class="cnt-badge" id="cnt-issue">0</span>
            </summary>
            <div class="list-box" id="list-issue"></div>
        </details>

        <details open>
            <summary class="head-novel">
                <span>ğŸ“– ì†Œì„¤ / ì¶”ì²œ</span>
                <span class="cnt-badge" id="cnt-novel">0</span>
            </summary>
            <div class="list-box" id="list-novel"></div>
        </details>

        <details>
            <summary class="head-chat">
                <span>ğŸ’¬ ì¡ë‹´ / ê¸°íƒ€</span>
                <span class="cnt-badge" id="cnt-chat">0</span>
            </summary>
            <div class="list-box" id="list-chat"></div>
        </details>
    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startProcess() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const targetCount = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-msg'),
            result: document.getElementById('result-area'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("í‚¤ì™€ ì‹œì‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.result.style.display = 'none';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');
        
        let collectedPosts = [];
        let currentPage = 1;
        
        try {
            // ==========================================
            // 1. í˜ì´ì§€ ìˆœíšŒí•˜ë©° ë°ì´í„° ì°¾ê¸° (Page Walker)
            // ==========================================
            ui.status.innerText = "ğŸ“¡ ë°ì´í„° ì¶”ì  ì¤‘ (í˜ì´ì§€ ìŠ¤ìº”)...";

            while (collectedPosts.length < targetCount) {
                // í˜ì´ì§€ ì•ˆì „ì¥ì¹˜ (ë„ˆë¬´ ë§ì´ ë’¤ì§€ì§€ ì•Šë„ë¡)
                if (currentPage > 10) break; 

                const targetUrl = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=${currentPage}`;
                const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                const html = await resp.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
                
                // í˜ì´ì§€ ë‚´ ê²Œì‹œë¬¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
                if (rows.length === 0) break;

                let postsOnPage = [];
                rows.forEach(row => {
                    const numNode = row.querySelector('.gall_num');
                    const titleNode = row.querySelector('.gall_tit a');
                    if(numNode && titleNode) {
                        const no = parseInt(numNode.innerText);
                        const title = titleNode.innerText.trim();
                        if(!isNaN(no)) postsOnPage.push({ no, title });
                    }
                });

                // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
                postsOnPage.sort((a,b) => b.no - a.no);

                // í˜„ì¬ í˜ì´ì§€ì˜ ê°€ì¥ ì‘ì€ ë²ˆí˜¸ í™•ì¸
                const minOnPage = postsOnPage[postsOnPage.length - 1].no;
                const maxOnPage = postsOnPage[0].no;

                // [ë¡œì§]
                // 1. ë§Œì•½ ì‹œì‘ë²ˆí˜¸ê°€ í˜„ì¬ í˜ì´ì§€ ë²”ìœ„ ì•ˆì— ìˆê±°ë‚˜, í˜„ì¬ í˜ì´ì§€ë³´ë‹¤ ë” ì˜›ë‚ (ì‘ì€) ë²ˆí˜¸ë¼ë©´ ìˆ˜ì§‘ ì‹œë„
                // 2. ë§Œì•½ ì‹œì‘ë²ˆí˜¸ê°€ í˜„ì¬ í˜ì´ì§€ Maxë³´ë‹¤ í›¨ì”¬ í¬ë©´? (ì´ë¯¸ ì§€ë‚˜ê°„ í˜ì´ì§€) -> ê·¸ëŸ´ì¼ì€ ì—†ìŒ(1í˜ì´ì§€ë¶€í„° í•˜ë‹ˆê¹Œ)
                
                // íƒ€ê²Ÿ ë²ˆí˜¸ê°€ ì´ í˜ì´ì§€ì— ìˆê±°ë‚˜, ì´ í˜ì´ì§€ë³´ë‹¤ ë” ê³¼ê±°ì— ìˆë‹¤ë©´
                if (startNo >= minOnPage) {
                    for (let p of postsOnPage) {
                        // ì‹œì‘ ë²ˆí˜¸ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²ƒë§Œ ìˆ˜ì§‘
                        if (p.no <= startNo) {
                            collectedPosts.push(p);
                            if (collectedPosts.length >= targetCount) break;
                        }
                    }
                }

                // ëª©í‘œ ë‹¤ ì±„ì› ìœ¼ë©´ íƒˆì¶œ
                if (collectedPosts.length >= targetCount) break;

                // ì•„ì§ ëª» ì±„ì› ëŠ”ë°, ì‹œì‘ ë²ˆí˜¸ê°€ ì´ í˜ì´ì§€ì˜ ìµœì†Œê°’ë³´ë‹¤ ì‘ë‹¤ë©´? -> ë‹¤ìŒ í˜ì´ì§€ë¡œ ê°€ì•¼ í•¨
                if (startNo < minOnPage) {
                    currentPage++;
                    continue; 
                }

                // í˜„ì¬ í˜ì´ì§€ë¥¼ ë‹¤ í›‘ì—ˆëŠ”ë°ë„ ë¶€ì¡±í•˜ë©´ ë‹¤ìŒ í˜ì´ì§€
                currentPage++;
            }

            if (collectedPosts.length === 0) throw new Error("ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

            // ==========================================
            // 2. AI ë¶„ì„ (Gemini 2.5 Flash)
            // ==========================================
            ui.status.innerText = `ğŸ§  AI ë¶„ì„ ì¤‘ (${collectedPosts.length}ê±´)...`;

            const MODEL_NAME = "gemini-2.5-flash"; 
            
            // íŒ: AIì—ê²Œ ì¤„ ë•Œ ë²ˆí˜¸ë§Œ ì£¼ì§€ ë§ê³  ì œëª©ë§Œ ê¹”ë”í•˜ê²Œ ì¤˜ì„œ í† í° ì•„ë¼ê¸°
            const prompt = `
            Classify these posts: 'issue' (controversy, complaints), 'novel' (review, recs), 'chat' (others).
            Output JSON: {"results": {"ID": {"c": "issue/novel/chat", "r": "short reason"}}}
            
            Data:
            ${collectedPosts.map(p => `${p.no}:${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            if(aiData.error) throw new Error(aiData.error.message);

            const rawText = aiData.candidates[0].content.parts[0].text;
            const resData = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // ==========================================
            // 3. ê²°ê³¼ ë Œë”ë§ (ì•„ì½”ë””ì–¸ ë¶„ë¥˜)
            // ==========================================
            let counts = { issue: 0, novel: 0, chat: 0 };

            collectedPosts.forEach(p => {
                const item = resData.results[p.no] || { c: 'chat', r: '-' };
                let cat = item.c;
                if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat'; // ì•ˆì „ì¥ì¹˜

                counts[cat]++;

                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <span class="item-no">${p.no}</span>
                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                    <span class="item-reason">${item.r}</span>
                `;
                ui.lists[cat].appendChild(div);
            });

            ui.cnts.issue.innerText = counts.issue;
            ui.cnts.novel.innerText = counts.novel;
            ui.cnts.chat.innerText = counts.chat;

            ui.result.style.display = 'block';
            ui.status.innerText = "âœ… ì™„ë£Œ";

        } catch (e) {
            console.error(e);
            ui.status.innerText = `âŒ ì˜¤ë¥˜: ${e.message}`;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
