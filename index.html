<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ë²¨í”¼ì•„ ìŠ¤ë§ˆíŠ¸ ëª¨ë‹ˆí„° v5.0 - Ultimate Edition</title>
    <style>
        /* [UI] íŠ¼íŠ¼í•œ ìŠ¤íƒ€ì¼ ì •ì˜ */
        :root {
            --primary-color: #5a2df2;
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --danger-color: #ef4444;
            --safe-color: #3b82f6;
            --neutral-color: #6b7280;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 40px;
            letter-spacing: -2px;
        }

        h1 span {
            color: var(--primary-color);
        }

        /* [Box] ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
        .control-box {
            background: var(--surface-color);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.06);
            margin-bottom: 30px;
        }

        .input-main {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .input-main:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px rgba(90, 45, 242, 0.1);
        }

        .top-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
        }

        .auto-check {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 800;
            color: var(--primary-color);
            background: rgba(90, 45, 242, 0.05);
            padding: 10px 18px;
            border-radius: 12px;
        }

        .auto-check input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .input-sub {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .input-sub:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            border-color: #f3f4f6;
        }

        button#btnRun {
            width: 100%;
            padding: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 20px rgba(90, 45, 242, 0.2);
        }

        button#btnRun:hover {
            background: #4823c4;
            transform: translateY(-2px);
        }

        button#btnRun:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* [Progress] í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .prog-wrap {
            margin-top: 30px;
        }

        .prog-container {
            height: 14px;
            background: #e5e7eb;
            border-radius: 7px;
            overflow: hidden;
            position: relative;
        }

        .prog-bar {
            height: 100%;
            background: linear-gradient(90deg, #5a2df2, #a855f7);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }

        .prog-info {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        /* [Result] ê²°ê³¼ ì¹´ë“œ */
        .category-box {
            background: var(--surface-color);
            margin-bottom: 15px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: 0.3s;
        }

        .category-header {
            padding: 20px 30px;
            cursor: pointer;
            font-weight: 800;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .category-header.issue { border-left: 8px solid var(--danger-color); color: var(--danger-color); }
        .category-header.novel { border-left: 8px solid var(--safe-color); color: var(--safe-color); }
        .category-header.chat { border-left: 8px solid var(--neutral-color); color: var(--neutral-color); }

        .list-container {
            padding: 0;
            display: none; /* ê¸°ë³¸ ë‹«í˜ */
            background: #fafafa;
        }

        .list-container.show {
            display: block;
        }

        .item {
            padding: 16px 30px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            font-size: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .item-no {
            width: 100px;
            color: #9ca3af;
            font-family: 'Fira Code', monospace;
            font-weight: 600;
        }

        .item-link {
            flex: 1;
            text-decoration: none;
            color: #374151;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 20px;
        }

        .item-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .item-reason {
            font-size: 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 5px 12px;
            border-radius: 10px;
            color: #6b7280;
            max-width: 300px;
        }

        .badge {
            background: #f3f4f6;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #4b5563;
        }

        /* [Console] ë¡œê·¸ ì˜ì—­ */
        #debug-console {
            background: #111827;
            color: #10b981;
            font-family: 'Fira Code', monospace;
            padding: 20px;
            border-radius: 20px;
            height: 150px;
            overflow-y: auto;
            margin-top: 30px;
            font-size: 13px;
            line-height: 1.6;
            border: 1px solid #374151;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>âš¡ ë…¸ë²¨í”¼ì•„ <span>ìŠ¤ë§ˆíŠ¸ ëª¨ë‹ˆí„°</span> v5.0</h1>

    <div class="control-box">
        <input type="password" id="apiKey" class="input-main" placeholder="ì—¬ê¸°ì— Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        
        <div class="top-row">
            <label class="auto-check">
                <input type="checkbox" id="autoLatest" checked onchange="handleAutoChange(this)"> 
                <span>ì‹¤ì‹œê°„ ìµœì‹ ê¸€ ìë™ ê°ì§€ (ì¶”ì²œ)</span>
            </label>
        </div>

        <div class="input-group">
            <div style="flex:1;">
                <label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">ì‹œì‘ ë²ˆí˜¸</label>
                <input type="number" id="startNo" class="input-sub" placeholder="ìë™ ê°ì§€ ì¤‘..." disabled>
            </div>
            <div style="flex:0.4;">
                <label style="font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block;">ìŠ¤ìº” ìˆ˜ëŸ‰</label>
                <input type="number" id="count" class="input-sub" value="20" min="1" max="200">
            </div>
        </div>
        
        <button id="btnRun" onclick="startMonitor()">ğŸš€ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ê°€ë™ ì‹œì‘</button>

        <div class="prog-wrap">
            <div class="prog-container">
                <div class="prog-bar" id="progBar"></div>
            </div>
            <div class="prog-info">
                <span id="status-text" style="color:#6b7280;">ë¶„ì„ ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ</span>
                <span id="progText" style="color:var(--primary-color);">0%</span>
            </div>
        </div>
    </div>

    <div id="result-area">
        <div class="category-box">
            <div class="category-header issue" onclick="toggleCategory('list-issue')">
                ğŸš¨ ë…¸í”¼ì•„ ì£¼ìš” ì´ìŠˆ <span class="badge" id="cnt-issue">0</span>
            </div>
            <div class="list-container show" id="list-issue"></div>
        </div>

        <div class="category-box">
            <div class="category-header novel" onclick="toggleCategory('list-novel')">
                ğŸ“– ì†Œì„¤ ê°ìƒ ë° ë¦¬ë·° <span class="badge" id="cnt-novel">0</span>
            </div>
            <div class="list-container show" id="list-novel"></div>
        </div>

        <div class="category-box">
            <div class="category-header chat" onclick="toggleCategory('list-chat')">
                ğŸ’¬ ì¼ë°˜ ì¡ë‹´ ë° ê¸°íƒ€ <span class="badge" id="cnt-chat">0</span>
            </div>
            <div class="list-container" id="list-chat"></div>
        </div>
    </div>

    <div id="debug-console">ğŸ–¥ï¸ [System] Novelpia Smart Monitor v5.0 Initialized...</div>
</div>

<script>
    /* ==========================================
       [í•µì‹¬ ë³€ìˆ˜ ë° ì„¤ì •]
       ========================================== */
    const PROXY_URL = "https://my-cors-proxy.syeru1209.workers.dev/?url=";
    const DC_URL = "https://gall.dcinside.com/mgallery/board";
    const GID = "genrenovel";

    // ì¹´í…Œê³ ë¦¬ í† ê¸€ í•¨ìˆ˜
    function toggleCategory(id) {
        document.getElementById(id).classList.toggle('show');
    }

    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    function log(msg) {
        const consoleBox = document.getElementById('debug-console');
        const timestamp = new Date().toLocaleTimeString();
        consoleBox.innerHTML += `\n[${timestamp}] > ${msg}`;
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    // ìë™ ê°ì§€ ì²´í¬ë°•ìŠ¤ í•¸ë“¤ëŸ¬
    function handleAutoChange(cb) {
        document.getElementById('startNo').disabled = cb.checked;
        if(cb.checked) {
            document.getElementById('startNo').placeholder = "ìë™ ê°ì§€ ì¤‘...";
            document.getElementById('startNo').value = "";
        } else {
            document.getElementById('startNo').placeholder = "ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”";
        }
    }

    /* ==========================================
       [ê¸°ëŠ¥ 1] ê³µì§€ì‚¬í•­ ë°•ë©¸ ìµœì‹ ê¸€ ë²ˆí˜¸ ì¶”ì¶œ
       ========================================== */
    async function getLatestNo() {
        log("ê°¤ëŸ¬ë¦¬ ëª©ë¡ì—ì„œ ê³µì§€ì‚¬í•­ì„ ì œì™¸í•œ ìµœì‹ ê¸€ì„ ì°¾ëŠ” ì¤‘...");
        try {
            const listUrl = `${DC_URL}/lists/?id=${GID}&page=1`;
            const response = await fetch(PROXY_URL + encodeURIComponent(listUrl));
            if (!response.ok) throw new Error("Proxy ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
            
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // ëª¨ë“  ê²Œì‹œê¸€ í–‰ì„ ê°€ì ¸ì˜´
            const rows = Array.from(doc.querySelectorAll('tr.ub-content.us-post'));
            
            for (let row of rows) {
                const numCell = row.querySelector('.gall_num');
                const subCell = row.querySelector('.gall_subject');
                
                // 1. ë²ˆí˜¸ê°€ 'ê³µì§€'ì´ê±°ë‚˜ ë§ë¨¸ë¦¬ê°€ 'ê³µì§€'ì¸ ê²½ìš° ë¬´ì¡°ê±´ íŒ¨ìŠ¤
                if (!numCell || numCell.innerText.includes('ê³µì§€') || (subCell && subCell.innerText.includes('ê³µì§€'))) {
                    continue;
                }
                
                // 2. í…ìŠ¤íŠ¸ê°€ ìˆ«ìì¸ ê²½ìš°ë§Œ ìµœì‹ ê¸€ë¡œ ì¸ì •
                const no = parseInt(numCell.innerText.trim());
                if (!isNaN(no) && no > 11000000) {
                    log(`ì§„ì§œ ìµœì‹ ê¸€ ë²ˆí˜¸ ê°ì§€ ì„±ê³µ: ${no}`);
                    return no;
                }
            }
            throw new Error("ìœ íš¨í•œ ê²Œì‹œê¸€ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
            log(`âš ï¸ ìµœì‹ ê¸€ ê°ì§€ ì˜¤ë¥˜: ${error.message}`);
            return null;
        }
    }

    /* ==========================================
       [ê¸°ëŠ¥ 2] ë©”ì¸ ëª¨ë‹ˆí„°ë§ ë¡œì§ (v4.1 ê¸°ë°˜ ë³µêµ¬)
       ========================================== */
    async function startMonitor() {
        // 0. ì´ˆê¸°í™”
        const key = document.getElementById('apiKey').value.trim();
        const autoMode = document.getElementById('autoLatest').checked;
        let startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        if (!key) return alert("Gemini API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        
        const ui = {
            btn: document.getElementById('btnRun'),
            progBar: document.getElementById('progBar'),
            progText: document.getElementById('progText'),
            status: document.getElementById('status-text'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            counts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        // UI ë¦¬ì…‹
        ui.lists.issue.innerHTML = ""; ui.lists.novel.innerHTML = ""; ui.lists.chat.innerHTML = "";
        ui.counts.issue.innerText = "0"; ui.counts.novel.innerText = "0"; ui.counts.chat.innerText = "0";
        ui.btn.disabled = true;
        ui.progBar.style.width = "0%";
        ui.progText.innerText = "0%";

        // 1. ìµœì‹ ê¸€ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        if (autoMode) {
            startNo = await getLatestNo();
            if (!startNo) {
                ui.btn.disabled = false;
                return alert("ê²Œì‹œê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        let processedData = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 10;
        let processedCount = 0;

        try {
            // ë©”ì¸ ë£¨í”„ (BATCH ë‹¨ìœ„ ì²˜ë¦¬)
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                const currentBatchCount = Math.min(BATCH_SIZE, totalCount - i);
                const batchIds = Array.from({length: currentBatchCount}, (_, idx) => (startNo - i) - idx);
                
                ui.status.innerText = `${batchIds[0]}ë²ˆ ëŒ€ì—­ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`;
                log(`${batchIds[0]}~${batchIds[batchIds.length-1]} êµ¬ê°„ ìˆ˜ì§‘ ì‹œì‘`);

                // ë³‘ë ¬ ìˆ˜ì§‘
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const viewUrl = `${DC_URL}/view/?id=${GID}&no=${no}`;
                        const response = await fetch(PROXY_URL + encodeURIComponent(viewUrl));
                        const html = await response.text();
                        
                        // [ê³µì§€ ë°•ë©¸] ë³¸ë¬¸ ë‚´ë¶€ì— ê³µì§€ íƒœê·¸ê°€ ë°œê²¬ë˜ë©´ íŒ¨ìŠ¤
                        if (html.includes('gall_num">ê³µì§€') || html.includes('<b>ê³µì§€</b>')) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 200) || "";
                        
                        if (title && !html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) {
                            return { id: String(no), title, body };
                        }
                    } catch (err) { return null; }
                    return null;
                });

                const rawPosts = await Promise.all(fetchPromises);
                const posts = rawPosts.filter(p => p !== null);

                // AI ë¶„ì„
                if (posts.length > 0) {
                    ui.status.innerText = `${posts.length}ê°œ ê²Œì‹œê¸€ ë¶„ì„ ì¤‘...`;
                    
                    const prompt = `ë‹¹ì‹ ì€ ì¥ë¥´ì†Œì„¤ ê°¤ëŸ¬ë¦¬ë¥¼ ì‹¤ì‹œê°„ ê°ì‹œí•˜ëŠ” ë…¸ë²¨í”¼ì•„ í”Œë«í¼ ëª¨ë‹ˆí„°ë§ ì§ì›ì…ë‹ˆë‹¤. 
                    ì•„ë˜ ê²Œì‹œê¸€ë“¤ì„ ë¶„ì„í•˜ì—¬ ë¶„ë¥˜í•˜ì„¸ìš”.
                    
                    ë¶„ë¥˜ ê¸°ì¤€:
                    1. 'issue': ë…¸ë²¨í”¼ì•„ í”Œë«í¼ ìì²´ì˜ ì˜¤ë¥˜, ê²°ì œ ì‹¤íŒ¨, ë·°ì–´ ì‘ë™ ë¶ˆëŸ‰, ìš´ì˜ì§„(ë…¸í”¼ì•„)ì— ëŒ€í•œ ì§ì ‘ì ì¸ ë¹„íŒ.
                       (ì£¼ì˜: ë””ì‹œì¸ì‚¬ì´ë“œ ê°¤ëŸ¬ë¦¬ ìš´ì˜ì§„/ì™„ì¥ êµì²´ ë“±ì˜ ë‚´ìš©ì€ ì ˆëŒ€ë¡œ 'issue'ê°€ ì•„ë‹ˆë¼ 'chat'ìœ¼ë¡œ ë¶„ë¥˜í•  ê²ƒ!)
                    2. 'novel': ì†Œì„¤ì— ëŒ€í•œ ì¶”ì²œ, ë¦¬ë·°, íŠ¹ì • ì‘í’ˆ ê°ìƒí‰.
                    3. 'chat': ê°¤ëŸ¬ë¦¬ ì¼ìƒ, ì™„ì¥ ì–¸ê¸‰, ë»˜ê¸€, ë…¸í”¼ì•„ì™€ ê´€ë ¨ ì—†ëŠ” ì¼ë°˜ ì¡ë‹´.

                    ì‘ë‹µì€ ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ í•  ê²ƒ:
                    {"results": {"ID": {"c": "issue/novel/chat", "r": "í•œê¸€ë¡œ ëœ ì§§ì€ ë¶„ë¥˜ ì´ìœ "}}}

                    ë°ì´í„°:
                    ${posts.map(p => `ID:${p.id}|ì œëª©:${p.title}|ë‚´ìš©:${p.body}`).join('\n')}`;

                    try {
                        const aiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }]
                            })
                        });
                        
                        const aiData = await aiResponse.json();
                        const rawAiText = aiData?.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/```json|```/g, "").trim();
                        
                        if (rawAiText) {
                            const resJson = JSON.parse(rawAiText);
                            
                            // [ìˆ˜ë™ ì¶œë ¥ ë¡œì§ ë³µêµ¬] ê° ê¸€ì„ ëŒë©° í™”ë©´ì— ì§ì ‘ ê½‚ì•„ì¤Œ
                            posts.forEach(p => {
                                const aiResult = (resJson.results && (resJson.results[p.id] || resJson.results[String(p.id)])) || { c: 'chat', r: 'ë¶„ì„ ë¶ˆê°€' };
                                const category = ['issue', 'novel', 'chat'].includes(aiResult.c) ? aiResult.c : 'chat';
                                
                                processedData[category]++;
                                
                                // ì•„ì´í…œ HTML ìƒì„±
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'item';
                                itemDiv.innerHTML = `
                                    <span class="item-no">${p.id}</span>
                                    <a href="${DC_URL}/view/?id=${GID}&no=${p.id}" target="_blank" class="item-link">${p.title}</a>
                                    <span class="item-reason">${aiResult.r}</span>
                                `;
                                
                                // í™”ë©´ì— ì¶”ê°€ (ì´ê²Œ ë¹ ì ¸ì„œ ê·¸ë™ì•ˆ ì•ˆë‚˜ì™”ë˜ê±°ì„)
                                ui.lists[category].appendChild(itemDiv);
                            });

                            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                            ui.counts.issue.innerText = processedData.issue;
                            ui.counts.novel.innerText = processedData.novel;
                            ui.counts.chat.innerText = processedData.chat;
                        }
                    } catch (aiErr) {
                        log(`âš ï¸ AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ${aiErr.message}`);
                    }
                }

                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                processedCount += currentBatchCount;
                const percent = Math.min(100, Math.round((processedCount / totalCount) * 100));
                ui.progBar.style.width = `${percent}%`;
                ui.progText.innerText = `${percent}%`;
            }
            
            ui.status.innerText = "ëª¨ë“  ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ";
            log(`âœ… ë¶„ì„ ì™„ë£Œ: ì´ ${processedCount}ê°œ ìŠ¤ìº”í•¨`);

        } catch (fatalErr) {
            log(`âŒ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ: ${fatalErr.message}`);
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
