<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¥´ì†Œì„¤ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§ v3</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ë˜ëŠ” ê°•í™” */
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #333; }
        .container { max-width: 650px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
        h2 { display: flex; align-items: center; gap: 12px; color: #1a1a1a; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #666; }
        input, button { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #e0e0e0; box-sizing: border-box; font-size: 15px; }
        input:focus { border-color: #5a2df2; outline: none; background: #fdfdff; }
        button { background: #5a2df2; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        button:hover { background: #451ec2; transform: translateY(-1px); }
        button:disabled { background: #cbd5e0; transform: none; }
        #status { font-weight: 700; color: #5a2df2; margin: 20px 0; text-align: center; font-size: 14px; }
        #log { font-size: 12px; color: #718096; background: #f1f5f9; padding: 12px; border-radius: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .result-card { border-bottom: 1px solid #f1f5f9; padding: 15px 5px; display: flex; justify-content: space-between; align-items: center; }
        .tag { font-size: 11px; padding: 5px 10px; border-radius: 6px; font-weight: 800; }
        .tag-site { background: #fff1f0; color: #e53e3e; border: 1px solid #feb2b2; }
        .tag-novel { background: #ebf8ff; color: #3182ce; border: 1px solid #90cdf4; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ ë…¸ë²¨ ë”¥ ëª¨ë‹ˆí„° v3</h2>
    
    <div class="input-group">
        <label>Gemini API Key</label>
        <input type="password" id="apiKey" placeholder="AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ ì…ë ¥">
    </div>
    <div class="input-group">
        <label>ì‹œì‘ ë²ˆí˜¸ (ë§ˆì§€ë§‰ ê¸€ ë²ˆí˜¸)</label>
        <input type="number" id="lastNo" placeholder="ì˜ˆ: 11744052">
    </div>
    <div class="input-group">
        <label>ê²€ì‚¬ ìˆ˜ëŸ‰ (í˜ì´ì§€ë‹¹ ì•½ 10-20ê°œ ê¶Œì¥)</label>
        <input type="number" id="count" value="10">
    </div>
    
    <button id="startBtn" onclick="run()">ì§€ëŠ¥í˜• ë¶„ì„ ì‹œì‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <div id="log"></div>
    <div id="results"><h3>ğŸ“Š ë¶„ì„ ëŒ€ê¸° ì¤‘</h3></div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function run() {
        const key = document.getElementById('apiKey').value;
        const lastNo = parseInt(document.getElementById('lastNo').value);
        const count = parseInt(document.getElementById('count').value);
        const logDiv = document.getElementById('log');
        const resDiv = document.getElementById('results');
        const btn = document.getElementById('startBtn');
        const statusDiv = document.getElementById('status');

        if(!key || !lastNo) return alert("ì„¤ì •ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");

        btn.disabled = true;
        logDiv.innerHTML = "<b>[System]</b> í”„ë¡œì„¸ìŠ¤ ì‹œì‘...<br>";
        resDiv.innerHTML = "<h3>ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„ ê²°ê³¼</h3>";
        let posts = [];

        try {
            // 1. ë³‘ë ¬ ë°ì´í„° ìˆ˜ì§‘ (ì†ë„ í–¥ìƒ)
            statusDiv.innerText = "ğŸ“¦ ê²Œì‹œê¸€ ìˆ˜ì§‘ ì¤‘...";
            for(let i = 0; i < count; i++) {
                const currentNo = lastNo - i;
                try {
                    const target = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${currentNo}`;
                    const res = await fetch(PROXY_URL + encodeURIComponent(target));
                    const html = await res.text();
                    
                    if (html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) continue;

                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const title = doc.querySelector('.title_subject')?.innerText;
                    
                    if(title) {
                        posts.push({ id: currentNo, title });
                        logDiv.innerHTML += `<div>âœ… ${currentNo} ìˆ˜ì§‘ ì™„ë£Œ</div>`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                    }
                } catch(e) { /* ê°œë³„ ì‹¤íŒ¨ ë¬´ì‹œ */ }
            }

            // 2. Gemini 2.0/2.5 Flash ë¶„ì„
            if(posts.length === 0) throw new Error("ìˆ˜ì§‘ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");

            statusDiv.innerText = "ğŸ§  Gemini Flash ì§€ëŠ¥ ë¶„ì„ ì¤‘...";
            
            // ëª¨ë¸ëª… ì—…ë°ì´íŠ¸: ìµœì‹  Flash ëª¨ë¸ ì‚¬ìš©
            const MODEL_NAME = "gemini-2.0-flash"; 
            
            const prompt = `ë‹¹ì‹ ì€ ì›¹ì†Œì„¤ ì»¤ë®¤ë‹ˆí‹° ê´€ë¦¬ìì…ë‹ˆë‹¤. 
            ë‹¤ìŒ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ 'site'(í”Œë«í¼ ê¸°ëŠ¥ ì˜¤ë¥˜, ê²°ì œ ë¬¸ì œ, ë·°ì–´ ë²„ê·¸)ì™€ 'novel'(ì†Œì„¤ ì¶”ì²œ, ê°ìƒ, ì‘ê°€ ì†Œì‹)ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.
            ì‘ë‹µì€ ë°˜ë“œì‹œ ìˆœìˆ˜ JSON ê°ì²´ í•˜ë‚˜ë§Œ ì¶œë ¥í•˜ì„¸ìš”. 
            í˜•ì‹: {"ID": "site" ë˜ëŠ” "novel"}
            ë‚´ìš©:
            ${posts.map(p => `${p.id}: ${p.title}`).join('\n')}`;

            const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        response_mime_type: "application/json" // JSON ëª¨ë“œ ê°•ì œ
                    }
                })
            });

            const data = await aiRes.json();
            if(data.error) throw new Error(data.error.message);

            const aiRawContent = data.candidates[0].content.parts[0].text;
            const resultJson = JSON.parse(aiRawContent);

            posts.forEach(p => {
                const category = resultJson[p.id] || "novel";
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <span><b>#${p.id}</b> ${p.title.substring(0, 25)}</span>
                    <span class="tag tag-${category}">${category === 'site' ? 'ğŸš¨ ì´ìŠˆ' : 'ğŸ“– ì†Œì„¤'}</span>
                `;
                resDiv.appendChild(card);
            });

            statusDiv.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";
        } catch(e) {
            console.error(e);
            statusDiv.innerText = "âŒ ì¤‘ë‹¨ë¨";
            logDiv.innerHTML += `<div style="color:#e53e3e;"><b>ì—ëŸ¬:</b> ${e.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
