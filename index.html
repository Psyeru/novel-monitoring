<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë¥´ì†Œì„¤ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f6fa; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #5a2df2; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        #log { margin-top: 20px; font-size: 13px; max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .result-card { border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; }
        .tag-site { color: #d32f2f; font-weight: bold; }
        .tag-novel { color: #5a2df2; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h2>
    <input type="text" id="apiKey" placeholder="Gemini API Key ì…ë ¥">
    <input type="number" id="lastNo" placeholder="ì‹œì‘ ê²Œì‹œë¬¼ ë²ˆí˜¸ (ì˜ˆ: 11744037)">
    <input type="number" id="count" placeholder="ê²€ì‚¬í•  ê°œìˆ˜ (ì˜ˆ: 20)" value="10">
    <button id="startBtn" onclick="run()">ë¶„ì„ ì‹œì‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <div id="log"></div>
    <div id="results"></div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function run() {
        const key = document.getElementById('apiKey').value;
        const lastNo = parseInt(document.getElementById('lastNo').value);
        const count = parseInt(document.getElementById('count').value);
        const logDiv = document.getElementById('log');
        const resDiv = document.getElementById('results');
        const btn = document.getElementById('startBtn');

        if(!key || !lastNo) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

        btn.disabled = true;
        logDiv.innerHTML = "";
        resDiv.innerHTML = "<h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>";

        let posts = [];
        
        // 1. ê²Œì‹œë¬¼ ë°ì´í„° ìˆ˜ì§‘ (í”„ë¡ì‹œ ê²½ìœ )
        for(let i = 0; i < count; i++) {
            const currentNo = lastNo - i;
            document.getElementById('status').innerText = `ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i+1}/${count})`;
            
            try {
                const target = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${currentNo}`;
                const res = await fetch(PROXY_URL + encodeURIComponent(target));
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                
                const title = doc.querySelector('.title_subject')?.innerText || "ì‚­ì œëœ ê²Œì‹œê¸€";
                const body = doc.querySelector('.write_div')?.innerText.substring(0, 200) || "";
                
                if(title !== "ì‚­ì œëœ ê²Œì‹œê¸€") {
                    posts.push({ id: currentNo, title, body });
                }
            } catch(e) { console.error(e); }
        }

        // 2. AI ë°°ì¹˜ ë¶„ì„ (10ê°œì”© ë¬¶ì–´ì„œ ì§ˆë¬¸)
        document.getElementById('status').innerText = "AI ë¶„ì„ ì¤‘ (ë°°ì¹˜ ì²˜ë¦¬)...";
        for (let i = 0; i < posts.length; i += 10) {
            const batch = posts.slice(i, i + 10);
            const prompt = `ì—­í• : ì†Œì„¤ í”Œë«í¼ ëª¨ë‹ˆí„° ìš”ì›. ì•„ë˜ ê²Œì‹œë¬¼ë“¤ì„ 'site'(í”Œë«í¼ ì˜¤ë¥˜/ë¬¸ì˜) ë˜ëŠ” 'novel'(ì†Œì„¤ë‚´ìš©/ì¶”ì²œ)ë¡œ ë¶„ë¥˜í•´.
            JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µí•´. ì˜ˆ: {"ë²ˆí˜¸": "ë¶„ë¥˜"}
            ${batch.map(p => `ë²ˆí˜¸ ${p.id}: ì œëª© ${p.title}`).join('\n')}`;

            try {
                const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await aiRes.json();
                const aiText = data.candidates[0].content.parts[0].text;
                const resultJson = JSON.parse(aiText.replace(/```json|```/g, ""));

                // ê²°ê³¼ ì¶œë ¥
                batch.forEach(p => {
                    const type = resultJson[p.id] || "unknown";
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <span>[${p.id}] ${p.title.substring(0, 20)}...</span>
                        <span class="tag-${type}">${type.toUpperCase()}</span>
                    `;
                    resDiv.appendChild(card);
                });
            } catch(e) { 
                console.error("AI ë¶„ì„ ì—ëŸ¬", e); 
                logDiv.innerHTML += `<div>âŒ ì¼ë¶€ ê²Œì‹œë¬¼ ë¶„ì„ ì‹¤íŒ¨</div>`;
            }
        }

        document.getElementById('status').innerText = "ë¶„ì„ ì™„ë£Œ!";
        btn.disabled = false;
    }
</script>
</body>
</html>
