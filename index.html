<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    function log(msg) {
        const consoleBox = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        consoleBox.innerHTML += `\n[${time}] ${msg}`;
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    async function startSystem() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            progBar: document.getElementById('progBar'),
            progText: document.getElementById('progText'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");

        // UI ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.progBar.style.width = '0%';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');
        document.getElementById('debug-console').innerHTML = "ğŸš€ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...";

        let counts = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 5;
        let processed = 0;

        try {
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                const currentBatchSize = Math.min(BATCH_SIZE, totalCount - i);
                const currentStartNo = startNo - i;
                const batchIds = Array.from({length: currentBatchSize}, (_, idx) => currentStartNo - idx);
                
                log(`[ë°°ì¹˜ ì‹œì‘] ${batchIds[0]} ~ ${batchIds[batchIds.length-1]} ë°ì´í„° ìˆ˜ì§‘...`);

                // 1. ìˆ˜ì§‘
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                        const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                        const html = await resp.text();
                        
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        // ìš•ì„¤ í•„í„°ë§ ë°©ì§€ë¥¼ ìœ„í•´ ë³¸ë¬¸ì€ ì¡°ê¸ˆë§Œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì œëª© ìœ„ì£¼ë¡œ ë¶„ì„
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 100) || "";
                        
                        if(title) return { no, title, body };
                        return null;
                    } catch(e) { return null; }
                });

                const rawPosts = await Promise.all(fetchPromises);
                const validPosts = rawPosts.filter(p => p !== null);
                
                if (validPosts.length > 0) {
                    log(`>> AI ë¶„ì„ ìš”ì²­ ì¤‘... (${validPosts.length}ê±´)`);
                    
                    // [ì¤‘ìš” 1] ëª¨ë¸ëª…: í˜„ì¬ APIì—ì„œ ì‘ë™í•˜ëŠ” ìµœì‹  2.0 ë²„ì „ ì´ë¦„
                    const MODEL_NAME = "gemini-2.0-flash-exp"; 
                    
                    const prompt = `
                    Analyze posts. Rules:
                    1. 'issue': ONLY for 'Novelpia' platform bugs/complaints.
                    2. 'novel': Review/Recs.
                    3. 'chat': School, Student Council, Daily life = Chat.
                    Output JSON Only: {"results": {"ID": {"c": "issue/novel/chat", "r": "Korean reason"}}}
                    Data:
                    ${validPosts.map(p => `ID:${p.no}|T:${p.title}|B:${p.body.replace(/\n/g, ' ')}`).join('\n')}
                    `;

                    try {
                        const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                // [ì¤‘ìš” 2] ì•ˆì „ í•„í„° í•´ì œ (ì´ê²Œ ì—†ìœ¼ë©´ ìš•ì„¤ ìˆëŠ” ê¸€ì—ì„œ ì—ëŸ¬ë‚¨)
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });
                        
                        const aiData = await aiResp.json();
                        
                        if(aiData.error) {
                            log(`âŒ API ì—ëŸ¬ ë°œìƒ: ${aiData.error.message}`);
                            log(`(íŒ: 404ë©´ ëª¨ë¸ëª… ë¬¸ì œ, 400ì´ë©´ ì•ˆì „í•„í„°/í‚¤ ë¬¸ì œ)`);
                        } else {
                            // ì•ˆì „ì¥ì¹˜: candidatesê°€ ë¹„ì–´ìˆìœ¼ë©´ ì•ˆì „í•„í„°ì— ê±¸ë¦° ê²ƒì„
                            if(!aiData.candidates || !aiData.candidates[0].content) {
                                log(`âš ï¸ AIê°€ ì‘ë‹µ ê±°ë¶€ (ì•ˆì „ í•„í„° ê°€ëŠ¥ì„±). í•´ë‹¹ ë°°ì¹˜ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.`);
                            } else {
                                let rawText = aiData.candidates[0].content.parts[0].text;
                                rawText = rawText.replace(/```json|```/g, "").trim();
                                const resData = JSON.parse(rawText);
                                
                                log(`>> AI ì‘ë‹µ ì„±ê³µ! ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤.`);

                                validPosts.forEach(p => {
                                    const info = resData.results[p.no] || { c: 'chat', r: '-' };
                                    let cat = info.c;
                                    if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat';

                                    counts[cat]++;
                                    
                                    const div = document.createElement('div');
                                    div.className = 'item';
                                    div.innerHTML = `
                                        <span class="item-no">${p.no}</span>
                                        <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                                        <span class="item-reason">${info.r}</span>
                                    `;
                                    ui.lists[cat].appendChild(div);
                                });

                                ui.cnts.issue.innerText = counts.issue;
                                ui.cnts.novel.innerText = counts.novel;
                                ui.cnts.chat.innerText = counts.chat;
                            }
                        }
                    } catch(err) {
                        log(`âŒ íŒŒì‹± ì˜¤ë¥˜: ${err.message}`);
                    }
                }

                processed += currentBatchSize;
                const percent = Math.min(100, Math.round((processed / totalCount) * 100));
                ui.progBar.style.width = `${percent}%`;
                document.getElementById('progText').innerText = `${percent}%`;
            }

            log("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ.");

        } catch (e) {
            log(`âŒ ì‹œìŠ¤í…œ ì¤‘ë‹¨: ${e.message}`);
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
