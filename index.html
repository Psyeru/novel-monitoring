<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨í”¼ì•„ ëª¨ë‹ˆí„°ë§ (ì§ì›ìš©)</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f8f9fa; --surface: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        .control-box { background: var(--surface); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 14px; border: 1px solid #e1e4e8; border-radius: 10px; font-size: 15px; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }

        .prog-container { height: 6px; background: #eee; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .prog-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }
        #status-msg { text-align: center; font-size: 13px; color: #666; margin-top: 5px; }

        details { background: white; margin-bottom: 12px; border-radius: 12px; border: 1px solid #eee; overflow: hidden; }
        summary { padding: 15px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; background: #fff; }
        
        .head-issue { border-left: 5px solid #e53e3e; color: #c53030; }
        .head-novel { border-left: 5px solid #3182ce; color: #2b6cb0; }
        .head-chat { border-left: 5px solid #a0aec0; color: #4a5568; }

        .item { padding: 10px 15px; border-top: 1px solid #f8f9fa; display: flex; align-items: center; font-size: 13px; }
        .item:hover { background: #f1f3f5; }
        .item-no { width: 70px; color: #adb5bd; font-size: 11px; }
        .item-link { flex: 1; text-decoration: none; color: #333; font-weight: 500; margin-right: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-reason { font-size: 11px; background: #eee; padding: 2px 8px; border-radius: 6px; color: #555; white-space: nowrap; }

        .cnt { background: #f1f3f5; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #495057; }
        
        /* ë¡œê·¸ì°½ ìŠ¤íƒ€ì¼ */
        #debug-console { 
            background: #1e1e1e; color: #00ff00; font-family: monospace; 
            padding: 15px; border-radius: 8px; font-size: 12px; 
            height: 120px; overflow-y: auto; margin-top: 20px; 
            white-space: pre-wrap; border: 1px solid #333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">âš¡ ë…¸ë²¨í”¼ì•„ ëª¨ë‹ˆí„°ë§ (ì§ì› ëª¨ë“œ)</h2>

    <div class="control-box">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744250)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startMonitor()">ğŸš€ ë¶„ì„ ì‹œì‘</button>
        
        <div class="prog-container"><div class="prog-bar" id="progBar"></div></div>
        <div style="display:flex; justify-content:space-between;">
            <span id="status-msg">ëŒ€ê¸° ì¤‘...</span>
            <span id="progText" style="font-size:12px; font-weight:bold;">0%</span>
        </div>
    </div>

    <div id="result-area">
        <details open><summary class="head-issue"><span>ğŸš¨ ë…¸í”¼ì•„ ì´ìŠˆ (ë¶ˆë§Œ/ì˜¤ë¥˜)</span><span class="cnt" id="cnt-issue">0</span></summary><div id="list-issue"></div></details>
        <details open><summary class="head-novel"><span>ğŸ“– ì†Œì„¤ (ë¦¬ë·°/ì¶”ì²œ)</span><span class="cnt" id="cnt-novel">0</span></summary><div id="list-novel"></div></details>
        <details><summary class="head-chat"><span>ğŸ’¬ ì¡ë‹´ (ì¼ìƒ/í•™ìƒíšŒ)</span><span class="cnt" id="cnt-chat">0</span></summary><div id="list-chat"></div></details>
    </div>

    <div id="debug-console">ğŸ–¥ï¸ ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘... (2.5 Flash ì¤€ë¹„ ì™„ë£Œ)</div>
</div>

<script>
    const PROXY_URL = "https://my-cors-proxy.syeru1209.workers.dev/?url=";

    function log(msg) {
        const consoleBox = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        consoleBox.innerHTML += `\n[${time}] ${msg}`;
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    async function startMonitor() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            progBar: document.getElementById('progBar'),
            progText: document.getElementById('progText'),
            status: document.getElementById('status-msg'),
            lists: { issue: document.getElementById('list-issue'), novel: document.getElementById('list-novel'), chat: document.getElementById('list-chat') },
            cnts: { issue: document.getElementById('cnt-issue'), novel: document.getElementById('cnt-novel'), chat: document.getElementById('cnt-chat') }
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // UI ë¦¬ì…‹
        ui.btn.disabled = true;
        ui.progBar.style.width = '0%';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');
        document.getElementById('debug-console').innerHTML = "ğŸš€ [gemini-2.5-flash] ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...";

        let counts = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 5; 
        let processed = 0;

        try {
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                const currentBatchSize = Math.min(BATCH_SIZE, totalCount - i);
                const currentStartNo = startNo - i;
                const batchIds = Array.from({length: currentBatchSize}, (_, idx) => currentStartNo - idx);
                
                log(`[ë°°ì¹˜ ì‹œì‘] ${batchIds[0]} ~ ${batchIds[batchIds.length-1]} ë°ì´í„° ìˆ˜ì§‘...`);
                ui.status.innerText = `ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i+1}~${i+currentBatchSize})`;

                // 1. ë³‘ë ¬ ìˆ˜ì§‘
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                        const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                        const html = await resp.text();
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        // ì†ë„ ìµœì í™”: ë³¸ë¬¸ ì• 200ìë§Œ ì¶”ì¶œ
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 200) || "";
                        
                        if(title) return { no, title, body };
                        return null;
                    } catch(e) { return null; }
                });

                const rawPosts = await Promise.all(fetchPromises);
                const posts = rawPosts.filter(p => p !== null);

                if (posts.length > 0) {
                    log(`>> ìˆ˜ì§‘ ì™„ë£Œ. 2.5 Flash ë¶„ì„ ìš”ì²­ ì¤‘... (${posts.length}ê±´)`);
                    
                    // [ì¤‘ìš”] ì‚¬ìš©ì ëª…ë ¹ì— ë”°ë¼ ëª¨ë¸ëª… gemini-2.5-flash ê°•ì œ ì ìš©
                    const MODEL_NAME = "gemini-2.5-flash"; 

                    // [ì¤‘ìš”] í˜ë¥´ì†Œë‚˜ ì ìš© (ë…¸ë²¨í”¼ì•„ ëª¨ë‹ˆí„°ë§ ì§ì›)
                    const prompt = `
                    ì—­í• : ë‹¹ì‹ ì€ 'ë…¸ë²¨í”¼ì•„(Novelpia)'ì˜ ëª¨ë‹ˆí„°ë§ ë‹´ë‹¹ ì§ì›ì…ë‹ˆë‹¤.
                    ë°°ê²½: ì—¬ê¸°ëŠ” 'ì¥ë¥´ì†Œì„¤ ê°¤ëŸ¬ë¦¬'ì…ë‹ˆë‹¤.

                    [ë¶„ë¥˜ ê¸°ì¤€]
                    1. 'issue' (ì´ìŠˆ/ë¶ˆë§Œ):
                       - í•µì‹¬: ì œëª©ì´ë‚˜ ë³¸ë¬¸ì— ì£¼ì–´ê°€ ì—†ë”ë¼ë„, ë·°ì–´/ê²°ì œ/ì‹œìŠ¤í…œ/ê¸°ëŠ¥ ê´€ë ¨ ë¶ˆë§Œì€ 99% 'ë…¸ë²¨í”¼ì•„' ê´€ë ¨ ê¸€ì´ë¯€ë¡œ 'issue'ë¡œ ë¶„ë¥˜í•  ê²ƒ.
                       - ì˜ˆ: "ë ‰ ê°œì©Œë„¤", "ì •ì‚° ì™œì´ë˜", "ê²€ì—´ ì‹¬í•˜ë„¤", "403 ì—ëŸ¬" -> ì „ë¶€ issue.
                    
                    2. 'novel' (ì†Œì„¤):
                       - íŠ¹ì • ì†Œì„¤ì˜ ë¦¬ë·°, ì¶”ì²œ, ê°ìƒ, ì‘ê°€ ê´€ë ¨ ì´ì•¼ê¸°.
                    
                    3. 'chat' (ì¡ë‹´):
                       - í•™ìƒíšŒ, í•™êµ, ê¸‰ì‹, ë‹¨ìˆœ ê°ì • í‘œí˜„, ìŒì‹ ì‚¬ì§„ ë“± í”Œë«í¼ê³¼ ë¬´ê´€í•œ ê¸€.

                    [ì¶œë ¥ í˜•ì‹]
                    - JSON í¬ë§·: {"results": {"ID": {"c": "issue/novel/chat", "r": "í•œê¸€ìš”ì•½"}}}
                    - r(ì´ìœ )ëŠ” ë°˜ë“œì‹œ í•œê¸€ë¡œ ì‘ì„±.

                    [ë°ì´í„°]
                    ${posts.map(p => `ID:${p.no}|T:${p.title}|B:${p.body.replace(/\n/g, ' ')}`).join('\n')}
                    `;

                    try {
                        const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });

                        const aiData = await aiResp.json();
                        
                        if(aiData.error) {
                            log(`âŒ API ì—ëŸ¬: ${aiData.error.message}`);
                        } else {
                            let rawText = aiData.candidates[0].content.parts[0].text;
                            const resData = JSON.parse(rawText.replace(/```json|```/g, "").trim());
                            
                            log(`>> ë¶„ì„ ì„±ê³µ! ë¦¬ìŠ¤íŠ¸ ê°±ì‹ .`);

                            posts.forEach(p => {
                                const info = resData.results[p.no] || { c: 'chat', r: 'ì˜¤ë¥˜' };
                                let cat = info.c;
                                if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat';

                                counts[cat]++;
                                
                                const div = document.createElement('div');
                                div.className = 'item';
                                div.innerHTML = `
                                    <span class="item-no">${p.no}</span>
                                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                                    <span class="item-reason">${info.r}</span>
                                `;
                                ui.lists[cat].appendChild(div);
                            });

                            ui.cnts.issue.innerText = counts.issue;
                            ui.cnts.novel.innerText = counts.novel;
                            ui.cnts.chat.innerText = counts.chat;
                        }
                    } catch(err) {
                        log(`âŒ íŒŒì‹± ì˜¤ë¥˜: ${err.message}`);
                    }
                }

                processed += currentBatchSize;
                const percent = Math.min(100, Math.round((processed / totalCount) * 100));
                ui.progBar.style.width = `${percent}%`;
                ui.progText.innerText = `${percent}%`;
            }

            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ";
            log("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ.");

        } catch (e) {
            log(`âŒ ì¤‘ë‹¨ë¨: ${e.message}`);
            ui.status.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ";
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
