<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ì¸í…”ë¦¬ì „ìŠ¤ ëª¨ë‹ˆí„°</title>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* í—¤ë” & ì…ë ¥ì°½ */
        h2 { margin-top: 0; color: #1a1a1a; display: flex; align-items: center; gap: 8px; }
        .control-panel { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        input, button { padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        button { background: #5a2df2; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #4824c9; }
        button:disabled { background: #ccc; cursor: wait; }

        /* ìš”ì•½ ëŒ€ì‹œë³´ë“œ */
        .summary-box { display: flex; gap: 15px; margin-bottom: 20px; display: none; }
        .stat-card { flex: 1; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-total { background: #f8f9fa; border: 1px solid #e9ecef; }
        .stat-issue { background: #fff5f5; border: 1px solid #ffc9c9; color: #c53030; }
        .stat-trend { flex: 2; background: #f0f5ff; border: 1px solid #c3dafe; color: #2b6cb0; text-align: left; display: flex; align-items: center; padding-left: 20px; font-weight: 600; font-size: 14px; }
        .stat-value { font-size: 24px; font-weight: 800; display: block; margin-top: 5px; }
        .stat-label { font-size: 12px; color: #666; font-weight: bold; }

        /* ë¡œê·¸ & í…Œì´ë¸” */
        #status { font-size: 13px; color: #5a2df2; margin-bottom: 10px; font-weight: 600; height: 20px; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 13px; display: none; }
        .report-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #eee; color: #555; }
        .report-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .report-table tr:hover { background: #fdfdfd; }
        
        /* íƒœê·¸ ìŠ¤íƒ€ì¼ */
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; white-space: nowrap; }
        .badge-issue { background: #ffe2e2; color: #e53e3e; } /* ì´ìŠˆ/ë¶ˆíƒ */
        .badge-review { background: #e6fffa; color: #2c7a7b; } /* ë¦¬ë·°/ì¶”ì²œ */
        .badge-chat { background: #edf2f7; color: #4a5568; } /* ì¡ë‹´ */
        .badge-info { background: #ebf8ff; color: #3182ce; } /* ì •ë³´/ì†Œì‹ */

        .title-link { text-decoration: none; color: #333; font-weight: 500; display: block; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .title-link:hover { color: #5a2df2; text-decoration: underline; }
        .id-cell { color: #999; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¡ ê°¤ëŸ¬ë¦¬ ì¸í…”ë¦¬ì „ìŠ¤ ëª¨ë‹ˆí„°</h2>
    
    <div class="control-panel">
        <input type="password" id="apiKey" placeholder="Gemini API Key">
        <input type="number" id="lastNo" placeholder="ì‹œì‘ ë²ˆí˜¸">
        <input type="number" id="count" value="15" placeholder="ìˆ˜ëŸ‰">
    </div>
    <button id="startBtn" onclick="run()" style="width:100%;">ğŸš€ ê³ ì† ë¶„ì„ ì‹œì‘</button>

    <div id="status"></div>

    <div class="summary-box" id="summaryBox">
        <div class="stat-card stat-total">
            <span class="stat-label">ë¶„ì„ëœ ê¸€</span>
            <span class="stat-value" id="valTotal">0</span>
        </div>
        <div class="stat-card stat-issue">
            <span class="stat-label">ê°ì§€ëœ ì´ìŠˆ</span>
            <span class="stat-value" id="valIssue">0</span>
        </div>
        <div class="stat-card stat-trend">
            <span id="valTrend">ë°ì´í„° ëŒ€ê¸° ì¤‘...</span>
        </div>
    </div>

    <table class="report-table" id="resultTable">
        <thead>
            <tr>
                <th width="10%">ë²ˆí˜¸</th>
                <th width="15%">ë¶„ë¥˜</th>
                <th width="50%">ì œëª©</th>
                <th width="25%">AI ì½”ë©˜íŠ¸</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function run() {
        const key = document.getElementById('apiKey').value;
        const lastNo = parseInt(document.getElementById('lastNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('startBtn'),
            status: document.getElementById('status'),
            summary: document.getElementById('summaryBox'),
            table: document.getElementById('resultTable'),
            tbody: document.getElementById('tableBody'),
            vTotal: document.getElementById('valTotal'),
            vIssue: document.getElementById('valIssue'),
            vTrend: document.getElementById('valTrend')
        };

        if(!key || !lastNo) return alert("ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");

        // ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.summary.style.display = 'none';
        ui.table.style.display = 'none';
        ui.tbody.innerHTML = "";
        
        try {
            // 1. ë³‘ë ¬ ë°ì´í„° ìˆ˜ì§‘ (ì†ë„ í•µì‹¬)
            ui.status.innerText = `âš¡ ${count}ê°œ ê²Œì‹œë¬¼ ë³‘ë ¬ ìˆ˜ì§‘ ì¤‘...`;
            
            // Promise.allë¡œ ë™ì‹œì— ìš”ì²­ ë‚ ë¦¬ê¸° (ìˆœì°¨ ì‹¤í–‰ X)
            const fetchPromises = Array.from({ length: count }, (_, i) => {
                const currentNo = lastNo - i;
                const target = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${currentNo}`;
                return fetch(PROXY_URL + encodeURIComponent(target))
                    .then(res => res.text())
                    .then(html => {
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")) return null;
                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText;
                        return title ? { id: currentNo, title } : null;
                    })
                    .catch(() => null);
            });

            const results = await Promise.all(fetchPromises);
            const posts = results.filter(p => p !== null); // ì‹¤íŒ¨/ì‚­ì œëœ ê¸€ ì œê±°

            if (posts.length === 0) throw new Error("ìˆ˜ì§‘ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");

            // 2. AI ë¶„ì„ (ë¦¬í¬íŠ¸ ëª¨ë“œ)
            ui.status.innerText = "ğŸ§  Gemini 2.0 Flash ë¶„ì„ ë³´ê³ ì„œ ìƒì„± ì¤‘...";

            const MODEL_NAME = "gemini-2.0-flash-exp"; 
            const prompt = `
            You are a community monitoring assistant. Analyze these post titles.
            
            1. Categorize each post into ONE of these: 
               - 'issue' (Platform bugs, payments, controversy, burning)
               - 'review' (Novel review, recommendation)
               - 'info' (News, author notice)
               - 'chat' (General chat, questions)
            
            2. Provide a 1-sentence summary of the overall atmosphere (Korean).
            3. Provide a very short reason for each classification (Korean).

            Response Format (JSON ONLY):
            {
                "summary": "Overall atmosphere summary here...",
                "data": {
                    "POST_ID": {"cat": "category_code", "reason": "short reason"}
                }
            }

            Titles:
            ${posts.map(p => `${p.id}: ${p.title}`).join('\n')}
            `;

            const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { response_mime_type: "application/json" }
                })
            });

            const data = await aiRes.json();
            const aiResult = JSON.parse(data.candidates[0].content.parts[0].text);

            // 3. ê²°ê³¼ ë Œë”ë§
            let issueCount = 0;
            
            posts.forEach(p => {
                const info = aiResult.data[p.id] || { cat: 'chat', reason: '-' };
                if(info.cat === 'issue') issueCount++;

                const row = document.createElement('tr');
                // ë±ƒì§€ ìƒ‰ìƒ ë§¤í•‘
                const badgeClass = `badge-${info.cat}`; 
                const catName = {
                    'issue': 'ğŸš¨ ì´ìŠˆ', 'review': 'ğŸ“– ë¦¬ë·°', 'info': 'ğŸ“¢ ì •ë³´', 'chat': 'ğŸ’¬ ì¡ë‹´'
                }[info.cat] || 'ê¸°íƒ€';

                row.innerHTML = `
                    <td class="id-cell">${p.id}</td>
                    <td><span class="badge ${badgeClass}">${catName}</span></td>
                    <td><a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.id}" target="_blank" class="title-link">${p.title}</a></td>
                    <td style="color:#666;">${info.reason}</td>
                `;
                ui.tbody.appendChild(row);
            });

            // ìƒë‹¨ ìš”ì•½ ì—…ë°ì´íŠ¸
            ui.vTotal.innerText = posts.length;
            ui.vIssue.innerText = issueCount;
            ui.vTrend.innerText = "ğŸ’¡ " + (aiResult.summary || "íŠ¹ì´ì‚¬í•­ ì—†ìŒ");
            
            // í™”ë©´ í‘œì‹œ
            ui.summary.style.display = 'flex';
            ui.table.style.display = 'table';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ";

        } catch (e) {
            console.error(e);
            ui.status.innerText = `âŒ ì˜¤ë¥˜: ${e.message}`;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
