<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¥ê°¤ ëª¨ë‹ˆí„°ë§</title>
    <style>
        :root { --primary: #6200ea; --bg: #f3f4f6; --surface: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", Roboto, sans-serif; background: var(--bg); color: #1f2937; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .control-panel { background: var(--surface); padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
        .input-group { display: flex; gap: 12px; margin-bottom: 16px; }
        input { flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; }
        input:focus { outline: none; border-color: var(--primary); }
        
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; }
        button:disabled { background: #d1d5db; cursor: not-allowed; }

        #status-msg { text-align: center; font-weight: 600; color: var(--primary); margin: 16px 0; min-height: 24px; }
        .error-box { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 12px; display: none; }

        .result-box { background: var(--surface); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; padding: 16px; text-align: left; font-weight: 600; color: #4b5563; border-bottom: 1px solid #e5e7eb; }
        td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        tr:hover { background: #f9fafb; }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .tag-issue { background: #fecaca; color: #991b1b; }
        .tag-novel { background: #bfdbfe; color: #1e40af; }
        .tag-chat { background: #f3f4f6; color: #374151; }
        
        .link { color: #111827; text-decoration: none; font-weight: 500; display: block; max-width: 380px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link:hover { color: var(--primary); text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">âš¡ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„° (ê³µì§€ ì œì™¸)</h2>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744142)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex: 0.4;">
        </div>
        <button id="btnRun" onclick="startEngine()">ë¶„ì„ ì‹œì‘</button>
        <div id="errorBox" class="error-box"></div>
    </div>

    <div id="status-msg">ì¤€ë¹„ ì™„ë£Œ</div>

    <div class="result-box" id="resultPanel">
        <table>
            <thead>
                <tr>
                    <th width="10%">No</th>
                    <th width="15%">ë¶„ë¥˜</th>
                    <th width="45%">ì œëª©</th>
                    <th width="30%">AI ìš”ì•½</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startEngine() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-msg'),
            error: document.getElementById('errorBox'),
            result: document.getElementById('resultPanel'),
            tbody: document.getElementById('resultBody')
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        ui.btn.disabled = true;
        ui.error.style.display = 'none';
        ui.result.style.display = 'none';
        ui.tbody.innerHTML = '';
        ui.status.innerText = "ğŸš€ ë°ì´í„° ìˆ˜ì§‘ ë° ì •ë ¬ ì¤‘...";

        try {
            // 1. ëª©ë¡ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
            const target = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=1`;
            const resp = await fetch(PROXY_URL + encodeURIComponent(target));
            if(!resp.ok) throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
            
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
            
            let posts = [];
            rows.forEach(row => {
                const numNode = row.querySelector('.gall_num');
                const titleNode = row.querySelector('.gall_tit a');
                
                // ê³µì§€, ì„¤ë¬¸, ì´ìŠˆ ë“±ìœ¼ë¡œ ì íŒ ê¸€ì€ ë²ˆí˜¸ íŒŒì‹±ì—ì„œ NaNì´ ë‚˜ì˜¤ê±°ë‚˜
                // ë²ˆí˜¸ê°€ ìˆì–´ë„ ì˜›ë‚  ë²ˆí˜¸ì¼ í™•ë¥ ì´ ë†’ìŒ
                if(numNode && titleNode) {
                    const noText = numNode.innerText.trim();
                    const no = parseInt(noText);
                    const title = titleNode.innerText.trim();

                    // 'ê³µì§€', 'ì„¤ë¬¸' ë“± í•œê¸€ë¡œ ëœ ë²ˆí˜¸ëŠ” ì œì™¸
                    if(!isNaN(no)) {
                        posts.push({ no, title });
                    }
                }
            });

            // 2. [í•µì‹¬ ìˆ˜ì •] ë²ˆí˜¸ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (í° ë²ˆí˜¸ -> ì‘ì€ ë²ˆí˜¸)
            // ì´ë ‡ê²Œ í•˜ë©´ ì˜›ë‚  ë²ˆí˜¸ì¸ ê³µì§€ì‚¬í•­ë“¤ì€ ë§¨ ë°‘ë°”ë‹¥ìœ¼ë¡œ ë‚´ë ¤ê°‘ë‹ˆë‹¤.
            posts.sort((a, b) => b.no - a.no);

            // 3. ì‹œì‘ ë²ˆí˜¸ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ê²ƒë§Œ í•„í„°ë§
            // (í˜¹ì‹œ ëª¨ë¥¼ ë¯¸ë˜ì˜ ê¸€ì´ë‚˜ í•€ ê³ ì •ê¸€ ë°©ì§€)
            const filteredPosts = posts.filter(p => p.no <= startNo);

            // 4. ì›í•˜ëŠ” ê°œìˆ˜ë§Œí¼ ìë¥´ê¸°
            const finalPosts = filteredPosts.slice(0, count);

            if(finalPosts.length === 0) throw new Error(`${startNo}ë²ˆ ê·¼ì²˜ì˜ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);

            // 5. AI ë¶„ì„ (Gemini 2.5 Flash)
            ui.status.innerText = `ğŸ§  Gemini 2.5 Flash ë¶„ì„ ì¤‘ (${finalPosts.length}ê±´)...`;

            const MODEL_NAME = "gemini-2.5-flash"; 
            const prompt = `
            Analyze these web novel community titles.
            Classify: 'issue' (Bug, Complaint, Controversy), 'novel' (Review, Chat, Rec), 'chat' (General).
            Provide short Korean reason.
            JSON Only: {"results": { "POST_ID": {"cat": "code", "reason": "text"} }}
            
            Titles:
            ${finalPosts.map(p => `${p.no}: ${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            if(aiData.error) throw new Error(aiData.error.message);

            const rawText = aiData.candidates[0].content.parts[0].text;
            const resultData = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // 6. ê²°ê³¼ ì¶œë ¥
            finalPosts.forEach(p => {
                const info = resultData.results[p.no] || { cat: 'chat', reason: '-' };
                
                const tr = document.createElement('tr');
                let badge = `<span class="badge tag-chat">ğŸ’¬ ì¡ë‹´</span>`;
                if(info.cat === 'issue') badge = `<span class="badge tag-issue">ğŸš¨ ì´ìŠˆ</span>`;
                if(info.cat === 'novel') badge = `<span class="badge tag-novel">ğŸ“– ì†Œì„¤</span>`;

                tr.innerHTML = `
                    <td style="color:#999;">${p.no}</td>
                    <td>${badge}</td>
                    <td><a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="link">${p.title}</a></td>
                    <td style="color:#666; font-size:13px;">${info.reason}</td>
                `;
                ui.tbody.appendChild(tr);
            });

            ui.result.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";

        } catch (e) {
            console.error(e);
            ui.status.innerText = "âŒ ì¤‘ë‹¨ë¨";
            ui.error.innerHTML = `ì˜¤ë¥˜: ${e.message}`;
            ui.error.style.display = 'block';
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
