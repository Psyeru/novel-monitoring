<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨í”¼ì•„ ë””ë²„ê¹… ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f8f9fa; --surface: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        .control-box { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .prog-container { height: 6px; background: #eee; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .prog-bar { height: 100%; background: #10b981; width: 0%; transition: width 0.3s; }

        /* ê²°ê³¼ ì˜ì—­ */
        details { background: white; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; overflow: hidden; }
        summary { padding: 14px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; background: #fff; }
        
        .head-issue { border-left: 5px solid #fa5252; color: #c92a2a; }
        .head-novel { border-left: 5px solid #4c6ef5; color: #364fc7; }
        .head-chat { border-left: 5px solid #868e96; color: #495057; }

        .item { padding: 10px 15px; border-top: 1px solid #f1f3f5; display: flex; align-items: center; font-size: 13px; }
        .item-no { width: 70px; color: #adb5bd; font-size: 11px; }
        .item-link { flex: 1; text-decoration: none; color: #333; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
        .item-reason { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px; }

        /* ë””ë²„ê·¸ ë¡œê·¸ ì°½ */
        #debug-console { 
            background: #1e1e1e; color: #00ff00; font-family: monospace; 
            padding: 15px; border-radius: 8px; font-size: 12px; 
            height: 150px; overflow-y: auto; margin-top: 20px; 
            white-space: pre-wrap; border: 1px solid #333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">âš¡ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ (Debug Mode)</h2>

    <div class="control-box">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744250)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startSystem()">ğŸš€ ë¶„ì„ ì‹œì‘</button>
        
        <div class="prog-container"><div class="prog-bar" id="progBar"></div></div>
        <div style="text-align:right; font-size:12px; margin-top:5px;" id="progText">0%</div>
    </div>

    <div id="result-area">
        <details open><summary class="head-issue"><span>ğŸš¨ ì´ìŠˆ</span><span id="cnt-issue">0</span></summary><div id="list-issue"></div></details>
        <details open><summary class="head-novel"><span>ğŸ“– ì†Œì„¤</span><span id="cnt-novel">0</span></summary><div id="list-novel"></div></details>
        <details><summary class="head-chat"><span>ğŸ’¬ ì¡ë‹´</span><span id="cnt-chat">0</span></summary><div id="list-chat"></div></details>
    </div>

    <div id="debug-console">ğŸ–¥ï¸ ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    // í™”ë©´ì— ë¡œê·¸ ì°ëŠ” í•¨ìˆ˜
    function log(msg) {
        const consoleBox = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        consoleBox.innerHTML += `\n[${time}] ${msg}`;
        consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    async function startSystem() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        if(!key || !startNo) return alert("ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");

        // UI ì´ˆê¸°í™”
        document.getElementById('btnRun').disabled = true;
        document.getElementById('progBar').style.width = '0%';
        ['list-issue','list-novel','list-chat'].forEach(id => document.getElementById(id).innerHTML = '');
        ['cnt-issue','cnt-novel','cnt-chat'].forEach(id => document.getElementById(id).innerText = '0');
        document.getElementById('debug-console').innerHTML = "ğŸš€ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...";

        let counts = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 5;
        let processed = 0;

        try {
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                const currentBatchSize = Math.min(BATCH_SIZE, totalCount - i);
                const currentStartNo = startNo - i;
                const batchIds = Array.from({length: currentBatchSize}, (_, idx) => currentStartNo - idx);
                
                log(`[ë°°ì¹˜ ì‹œì‘] ${batchIds[0]} ~ ${batchIds[batchIds.length-1]} ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`);

                // 1. ìˆ˜ì§‘
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                        const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                        const html = await resp.text();
                        
                        // ë””ë²„ê¹…: ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì°¨ë‹¨/ì˜¤ë¥˜ ì˜ì‹¬
                        if(html.length < 500) {
                            return { error: `HTML ê¸¸ì´ ë¶€ì¡± (${html.length})` };
                        }
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 100) || "";
                        
                        if(title) return { no, title, body };
                        return { error: "ì œëª© íŒŒì‹± ì‹¤íŒ¨" };
                    } catch(e) { return { error: e.message }; }
                });

                const rawPosts = await Promise.all(fetchPromises);
                
                // ìˆ˜ì§‘ ê²°ê³¼ ë¡œê·¸ í™•ì¸
                const validPosts = rawPosts.filter(p => p && p.no);
                const errors = rawPosts.filter(p => p && p.error);
                
                log(`>> ìˆ˜ì§‘ ì™„ë£Œ: ì„±ê³µ ${validPosts.length}ê±´ / ì‹¤íŒ¨ ${errors.length}ê±´ / ì‚­ì œ ${rawPosts.filter(p=>p===null).length}ê±´`);
                
                if (validPosts.length > 0) {
                    log(`>> AI ë¶„ì„ ìš”ì²­ ì¤‘... (${validPosts.length}ê±´)`);
                    
                    const MODEL_NAME = "gemini-2.0-flash-exp"; 
                    const prompt = `
                    Analyze posts. Rules:
                    1. 'issue': Novelpia platform bugs/complaints ONLY.
                    2. 'novel': Review/Recs.
                    3. 'chat': School, Student Council, Daily life = Chat.
                    Output JSON Only: {"results": {"ID": {"c": "issue/novel/chat", "r": "Korean reason"}}}
                    Data:
                    ${validPosts.map(p => `ID:${p.no}|T:${p.title}|B:${p.body.replace(/\n/g, ' ')}`).join('\n')}
                    `;

                    try {
                        const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        const aiData = await aiResp.json();
                        
                        if(aiData.error) {
                            log(`âŒ API ì—ëŸ¬: ${aiData.error.message}`);
                        } else {
                            let rawText = aiData.candidates[0].content.parts[0].text;
                            rawText = rawText.replace(/```json|```/g, "").trim();
                            const resData = JSON.parse(rawText);
                            
                            log(`>> AI ì‘ë‹µ ìˆ˜ì‹  ì„±ê³µ. ë¦¬ìŠ¤íŠ¸ ê°±ì‹ .`);

                            // ê²°ê³¼ ë¿Œë¦¬ê¸° (ê°•ì œ ë Œë”ë§)
                            validPosts.forEach(p => {
                                // AIê°€ ì‘ë‹µì„ ì•ˆ ì¤¬ì–´ë„ ê°•ì œë¡œ 'chat'ìœ¼ë¡œë¼ë„ ë„ì›€ (ì¦ë°œ ë°©ì§€)
                                const info = resData.results[p.no] || { c: 'chat', r: 'AIì‘ë‹µì—†ìŒ' };
                                let cat = info.c;
                                if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat';

                                counts[cat]++;
                                
                                const div = document.createElement('div');
                                div.className = 'item';
                                div.innerHTML = `
                                    <span class="item-no">${p.no}</span>
                                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                                    <span class="item-reason">${info.r}</span>
                                `;
                                document.getElementById(`list-${cat}`).appendChild(div);
                            });

                            // ì¹´ìš´íŠ¸ ê°±ì‹ 
                            document.getElementById('cnt-issue').innerText = counts.issue;
                            document.getElementById('cnt-novel').innerText = counts.novel;
                            document.getElementById('cnt-chat').innerText = counts.chat;
                        }
                    } catch(err) {
                        log(`âŒ íŒŒì‹±/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${err.message}`);
                    }
                } else {
                    log(`âš ï¸ ë¶„ì„í•  ìœ íš¨í•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë‘ ì‚­ì œë˜ì—ˆê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨)`);
                }

                processed += currentBatchSize;
                const percent = Math.min(100, Math.round((processed / totalCount) * 100));
                document.getElementById('progBar').style.width = `${percent}%`;
                document.getElementById('progText').innerText = `${percent}%`;
            }

            log("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ.");

        } catch (e) {
            log(`âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: ${e.message}`);
        } finally {
            document.getElementById('btnRun').disabled = false;
        }
    }
</script>
</body>
</html>
