<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨í”¼ì•„ ì‹¬ì¸µ ë¶„ì„ê¸°</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f8f9fa; --surface: #ffffff; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-box { background: var(--surface); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 14px; border: 1px solid #e1e4e8; border-radius: 10px; font-size: 15px; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        button { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-area { margin-top: 20px; display: none; }
        .progress-bg { width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease-out; }
        .progress-text { text-align: right; font-size: 13px; font-weight: bold; color: var(--primary); }
        #status-msg { text-align: center; font-size: 14px; color: #666; margin-top: 5px; }

        /* ê²°ê³¼ ì˜ì—­ (ì•„ì½”ë””ì–¸) */
        #result-area { display: none; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        details { background: white; margin-bottom: 12px; border-radius: 12px; border: 1px solid #f1f3f5; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        summary { padding: 16px 20px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; background: #fff; user-select: none; transition: background 0.2s; }
        summary:hover { background: #f8f9fa; }

        /* í—¤ë” ìƒ‰ìƒ */
        .head-issue { border-left: 5px solid #fa5252; color: #c92a2a; }
        .head-novel { border-left: 5px solid #4c6ef5; color: #364fc7; }
        .head-chat { border-left: 5px solid #868e96; color: #495057; }
        .cnt { background: #f1f3f5; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #495057; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .item { padding: 12px 20px; border-top: 1px solid #f8f9fa; display: flex; align-items: center; font-size: 14px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .item:hover { background: #f8f9fa; }
        
        .item-no { width: 80px; color: #adb5bd; font-size: 12px; font-family: monospace; }
        .item-link { flex: 1; text-decoration: none; color: #212529; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 15px; }
        .item-link:hover { text-decoration: underline; color: var(--primary); }
        .item-reason { font-size: 12px; color: #495057; background: #e9ecef; padding: 4px 8px; border-radius: 6px; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        
        /* ì—ëŸ¬ ë°•ìŠ¤ */
        .error-log { color: #e03131; font-size: 12px; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-bottom:20px;">âš¡ ë…¸ë²¨í”¼ì•„ ì‹¬ì¸µ ë¶„ì„ê¸°</h2>

    <div class="control-box">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key ì…ë ¥">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744220)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰ (20~30 ê¶Œì¥)" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startStream()">ğŸš€ ë¶„ì„ ì‹œì‘</button>

        <div class="progress-area" id="progArea">
            <div class="progress-bg"><div class="progress-fill" id="progFill"></div></div>
            <div style="display:flex; justify-content:space-between;">
                <span id="status-msg">ì¤€ë¹„ ì¤‘...</span>
                <span class="progress-text" id="progText">0%</span>
            </div>
        </div>
        <div id="errorLog" class="error-log"></div>
    </div>

    <div id="result-area">
        <details open>
            <summary class="head-issue">
                <span>ğŸš¨ ì´ìŠˆ / ë¶ˆíƒ</span>
                <span class="cnt" id="cnt-issue">0</span>
            </summary>
            <div id="list-issue"></div>
        </details>

        <details open>
            <summary class="head-novel">
                <span>ğŸ“– ì†Œì„¤ / ì¶”ì²œ</span>
                <span class="cnt" id="cnt-novel">0</span>
            </summary>
            <div id="list-novel"></div>
        </details>

        <details>
            <summary class="head-chat">
                <span>ğŸ’¬ ì¡ë‹´ (ì¼ìƒ/í•™êµ)</span>
                <span class="cnt" id="cnt-chat">0</span>
            </summary>
            <div id="list-chat"></div>
        </details>
    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startStream() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            progArea: document.getElementById('progArea'),
            progFill: document.getElementById('progFill'),
            progText: document.getElementById('progText'),
            status: document.getElementById('status-msg'),
            error: document.getElementById('errorLog'),
            result: document.getElementById('result-area'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // UI ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.error.style.display = 'none';
        ui.error.innerText = '';
        ui.result.style.display = 'block';
        ui.progArea.style.display = 'block';
        ui.progFill.style.width = '0%';
        ui.progText.innerText = '0%';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');
        
        let counts = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 5; // 5ê°œì”© ëŠì–´ì„œ ì²˜ë¦¬ (ì²´ê° ì†ë„ í–¥ìƒ)
        let processed = 0;

        try {
            // ì „ì²´ ë£¨í”„ (Batch ë‹¨ìœ„)
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                const currentBatchSize = Math.min(BATCH_SIZE, totalCount - i);
                const currentStartNo = startNo - i;
                // ì´ë²ˆ í„´ì— ê¸ì–´ì˜¬ ë²ˆí˜¸ë“¤ (ì˜ˆ: 100, 99, 98, 97, 96)
                const batchIds = Array.from({length: currentBatchSize}, (_, idx) => currentStartNo - idx);
                
                ui.status.innerText = `ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i+1}~${i+currentBatchSize}ë²ˆì§¸)`;

                // 1. ë³‘ë ¬ ìˆ˜ì§‘ (ë³¸ë¬¸ í¬í•¨)
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                        const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                        const html = await resp.text();
                        
                        // ì‚­ì œ/ì¡´ì¬í•˜ì§€ ì•ŠìŒ ì²´í¬
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        // ë³¸ë¬¸ 100ìë§Œ (ì†ë„ ìµœì í™”)
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 100) || "";
                        
                        if(title) return { no, title, body };
                        return null;
                    } catch(e) { return null; }
                });

                const rawPosts = await Promise.all(fetchPromises);
                const posts = rawPosts.filter(p => p !== null);

                // ìˆ˜ì§‘ëœ ê¸€ì´ ìˆìœ¼ë©´ ë¶„ì„ ì‹œì‘
                if (posts.length > 0) {
                    ui.status.innerText = `ğŸ§  Gemini ë¶„ì„ ì¤‘...`;
                    
                    // 2. AI ë¶„ì„ ìš”ì²­
                    const MODEL_NAME = "gemini-2.0-flash-exp"; 
                    const prompt = `
                    Analyze these posts (Title+Body).
                    
                    [Rules]
                    1. 'issue': STRICTLY for 'Novelpia' platform bugs, billing, operational complaints.
                    2. 'novel': Novel reviews, recommendations.
                    3. 'chat': **Student council, School, Daily life, Embarrassing moments, Food** (MUST be 'chat').
                    
                    [Output]
                    JSON Only: {"results": {"ID": {"c": "issue/novel/chat", "r": "Korean short reason"}}}
                    
                    [Data]
                    ${posts.map(p => `ID:${p.no}|T:${p.title}|B:${p.body.replace(/\n/g, ' ')}`).join('\n')}
                    `;

                    try {
                        const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        const aiData = await aiResp.json();
                        
                        if (aiData.error) {
                            console.error(aiData.error);
                            ui.error.style.display = 'block';
                            ui.error.innerText += ` [${i+1}êµ¬ê°„ API ì˜¤ë¥˜] `;
                        } else {
                            // JSON íŒŒì‹± ì•ˆì „ì¥ì¹˜
                            let rawText = aiData.candidates[0].content.parts[0].text;
                            // ë§ˆí¬ë‹¤ìš´ ì œê±°
                            rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                            // í˜¹ì‹œ ëª¨ë¥¼ ì•ë’¤ ê³µë°± ì œê±° í›„ íŒŒì‹±
                            const resData = JSON.parse(rawText);

                            // 3. UI ê°±ì‹  (ìŠ¤íŠ¸ë¦¬ë°)
                            posts.forEach(p => {
                                const info = resData.results[p.no] || { c: 'chat', r: 'ë¶„ì„ì‹¤íŒ¨' };
                                let cat = info.c;
                                // ì•ˆì „ì¥ì¹˜: ì´ìƒí•œ ì¹´í…Œê³ ë¦¬ëŠ” ì¡ë‹´ìœ¼ë¡œ
                                if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat';

                                counts[cat]++;
                                
                                const div = document.createElement('div');
                                div.className = 'item';
                                div.innerHTML = `
                                    <span class="item-no">${p.no}</span>
                                    <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                                    <span class="item-reason">${info.r}</span>
                                `;
                                ui.lists[cat].appendChild(div);
                            });

                            // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                            ui.cnts.issue.innerText = counts.issue;
                            ui.cnts.novel.innerText = counts.novel;
                            ui.cnts.chat.innerText = counts.chat;
                        }
                    } catch (err) {
                        console.error("AI íŒŒì‹± ì‹¤íŒ¨", err);
                    }
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                processed += currentBatchSize;
                const percent = Math.min(100, Math.round((processed / totalCount) * 100));
                ui.progFill.style.width = `${percent}%`;
                ui.progText.innerText = `${percent}%`;
            }

            ui.status.innerText = "âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ!";
            ui.progFill.style.background = "#10b981"; // ì´ˆë¡ìƒ‰ ì™„ë£Œ

        } catch (e) {
            console.error(e);
            ui.status.innerText = "âŒ ì¤‘ë‹¨ë¨";
            ui.error.style.display = 'block';
            ui.error.innerText = e.message;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
