<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„° (v2.5)</title>
    <style>
        :root { --primary: #6200ea; --bg: #f3f4f6; --surface: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", Roboto, sans-serif; background: var(--bg); color: #1f2937; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
        .control-panel { background: var(--surface); padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
        .input-group { display: flex; gap: 12px; margin-bottom: 16px; }
        input { flex: 1; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: border 0.2s; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(98, 0, 234, 0.1); }
        
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #d1d5db; cursor: not-allowed; }

        /* ìƒíƒœì°½ & ì—ëŸ¬ */
        #status-msg { text-align: center; font-weight: 600; color: var(--primary); margin: 16px 0; min-height: 24px; }
        .error-box { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 12px; display: none; line-height: 1.5; }

        /* ê²°ê³¼ í…Œì´ë¸” */
        .result-box { background: var(--surface); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f9fafb; padding: 16px; text-align: left; font-weight: 600; color: #4b5563; border-bottom: 1px solid #e5e7eb; }
        td { padding: 14px 16px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        tr:hover { background: #f9fafb; }
        
        /* ë±ƒì§€ */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .tag-issue { background: #fecaca; color: #991b1b; }
        .tag-novel { background: #bfdbfe; color: #1e40af; }
        .tag-chat { background: #f3f4f6; color: #374151; }
        
        .link { color: #111827; text-decoration: none; font-weight: 500; display: block; max-width: 380px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link:hover { color: var(--primary); text-decoration: underline; }
        .comment { color: #6b7280; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 24px;">
        <h2 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px;">
            âš¡ ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„° <span style="font-size: 12px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555;">v2.5 Flash</span>
        </h2>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-group">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744142)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰" style="flex: 0.4;">
        </div>
        <button id="btnRun" onclick="startEngine()">Gemini 2.5 ë¶„ì„ ì‹œì‘</button>
        <div id="errorBox" class="error-box"></div>
    </div>

    <div id="status-msg">ì¤€ë¹„ ì™„ë£Œ</div>

    <div class="result-box" id="resultPanel">
        <table>
            <thead>
                <tr>
                    <th width="10%">No</th>
                    <th width="12%">ë¶„ë¥˜</th>
                    <th width="48%">ì œëª©</th>
                    <th width="30%">AI ìš”ì•½</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    // ì‚¬ìš©ì Worker í”„ë¡ì‹œ
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startEngine() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-msg'),
            error: document.getElementById('errorBox'),
            result: document.getElementById('resultPanel'),
            tbody: document.getElementById('resultBody')
        };

        if(!key || !startNo) {
            alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // UI ë¦¬ì…‹
        ui.btn.disabled = true;
        ui.error.style.display = 'none';
        ui.result.style.display = 'none';
        ui.tbody.innerHTML = '';
        ui.status.innerText = "ğŸš€ ë¦¬ìŠ¤íŠ¸ ê³ ì† ìˆ˜ì§‘ ì¤‘...";

        try {
            // 1. ëª©ë¡ í˜ì´ì§€ í†µì§¸ë¡œ ê¸ì–´ì˜¤ê¸° (ì†ë„ 10ë°° í–¥ìƒ)
            const target = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=1`;
            const resp = await fetch(PROXY_URL + encodeURIComponent(target));
            if(!resp.ok) throw new Error("í”„ë¡ì‹œ ì„œë²„ ì ‘ì† ì‹¤íŒ¨");
            
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
            
            let posts = [];
            rows.forEach(row => {
                const numNode = row.querySelector('.gall_num');
                const titleNode = row.querySelector('.gall_tit a');
                if(numNode && titleNode) {
                    const no = parseInt(numNode.innerText);
                    const title = titleNode.innerText.trim();
                    // ìœ íš¨í•œ ë²ˆí˜¸ì´ê³ , ì‹œì‘ë²ˆí˜¸ë³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì„ ë•Œ ìˆ˜ì§‘
                    if(!isNaN(no) && no <= startNo) posts.push({ no, title });
                }
            });

            // ê°œìˆ˜ ì œí•œ
            posts = posts.slice(0, count);

            if(posts.length === 0) throw new Error(`${startNo}ë²ˆ ì´í•˜ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜ì´ì§€ê°€ ë°€ë ¸ì„ ìˆ˜ ìˆìŒ)`);

            // 2. Gemini 2.5 Flash í˜¸ì¶œ
            ui.status.innerText = `ğŸ§  Gemini 2.5 Flash ë¶„ì„ ì¤‘ (${posts.length}ê±´)...`;

            // ìš”ì²­í•˜ì‹  2.5 ëª¨ë¸ëª… ì ìš©
            const MODEL_NAME = "gemini-2.5-flash"; 

            const prompt = `
            Analyze these titles from a web novel community.
            Classify them into: 'issue' (Bugs, Complaints, Controversy), 'novel' (Review, Recommendation, Chat), 'chat' (General).
            Provide a short reason in Korean.
            Output JSON only: {"results": { "POST_ID": {"cat": "code", "reason": "text"} }}
            
            Titles:
            ${posts.map(p => `${p.no}: ${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();

            // ì—ëŸ¬ í•¸ë“¤ë§ (ëª¨ë¸ëª…ì´ í‹€ë ¸ê±°ë‚˜ ì—†ëŠ” ê²½ìš°)
            if(aiData.error) {
                let msg = aiData.error.message;
                if(msg.includes("not found")) {
                    msg += `<br>âš ï¸ <b>íŒ:</b> 'gemini-2.5-flash'ê°€ ì•„ì§ ë°°í¬ë˜ì§€ ì•Šì•˜ê±°ë‚˜ API ì´ë¦„ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ 2.0-flash ì‚¬ìš© ê¶Œì¥)`;
                }
                throw new Error(msg);
            }

            // ê²°ê³¼ íŒŒì‹±
            const rawText = aiData.candidates[0].content.parts[0].text;
            const jsonText = rawText.replace(/```json|```/g, "").trim();
            const resultData = JSON.parse(jsonText);

            // 3. í™”ë©´ ì¶œë ¥
            posts.forEach(p => {
                const info = resultData.results[p.no] || { cat: 'chat', reason: '-' };
                
                const tr = document.createElement('tr');
                let badge = `<span class="badge tag-chat">ğŸ’¬ ì¡ë‹´</span>`;
                if(info.cat === 'issue') badge = `<span class="badge tag-issue">ğŸš¨ ì´ìŠˆ</span>`;
                if(info.cat === 'novel') badge = `<span class="badge tag-novel">ğŸ“– ì†Œì„¤</span>`;

                tr.innerHTML = `
                    <td style="color:#999;">${p.no}</td>
                    <td>${badge}</td>
                    <td><a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="link">${p.title}</a></td>
                    <td class="comment">${info.reason}</td>
                `;
                ui.tbody.appendChild(tr);
            });

            ui.result.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";

        } catch (e) {
            console.error(e);
            ui.status.innerText = "âŒ ë¶„ì„ ì¤‘ë‹¨";
            ui.error.innerHTML = `<b>ì˜¤ë¥˜ ë°œìƒ:</b> ${e.message}`;
            ui.error.style.display = 'block';
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>

</body>
</html>
