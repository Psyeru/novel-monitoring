<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨í”¼ì•„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f4f6f8; --white: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }

        .control-box { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: progress; }

        #progress-bar { height: 4px; background: #eee; width: 100%; border-radius: 2px; overflow: hidden; display: none; margin-top: 10px; }
        #progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        #status { text-align: center; margin: 10px 0; font-weight: 600; color: var(--primary); font-size: 14px; min-height: 20px; }

        /* ì•„ì½”ë””ì–¸ UI */
        details { background: white; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; overflow: hidden; }
        summary { padding: 14px 16px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; background: #fff; user-select: none; }
        summary:hover { background: #f9f9f9; }

        /* ì¹´í…Œê³ ë¦¬ í—¤ë” */
        .head-issue { border-left: 5px solid #e53e3e; color: #c53030; } 
        .head-novel { border-left: 5px solid #3182ce; color: #2b6cb0; } 
        .head-chat { border-left: 5px solid #a0aec0; color: #4a5568; } 

        .cnt { background: #f1f3f5; padding: 2px 8px; border-radius: 12px; font-size: 12px; color: #495057; }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .item { padding: 10px 16px; border-top: 1px solid #f1f3f5; display: flex; align-items: center; font-size: 13px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .item:hover { background: #f8f9fa; }
        .item-no { width: 70px; color: #adb5bd; font-size: 12px; font-family: monospace; }
        .item-link { flex: 1; text-decoration: none; color: #333; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .item-link:hover { text-decoration: underline; color: var(--primary); }
        .item-reason { font-size: 11px; color: #666; background: #e9ecef; padding: 3px 8px; border-radius: 4px; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-bottom:20px;">âš¡ ë…¸ë²¨í”¼ì•„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h2>

    <div class="control-box">
        <div class="input-row">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="input-row">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744220)">
            <input type="number" id="count" value="20" placeholder="ìˆ˜ëŸ‰ (20 ê¶Œì¥)" style="flex:0.4;">
        </div>
        <button id="btnRun" onclick="startStream()">ğŸš€ ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘</button>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div id="status">ì¤€ë¹„ ì™„ë£Œ</div>

    <div id="result-area" style="display:none;">
        <details open>
            <summary class="head-issue">
                <span>ğŸš¨ ë…¸ë²¨í”¼ì•„ ì´ìŠˆ (ë¶ˆíƒ/ì˜¤ë¥˜)</span>
                <span class="cnt" id="cnt-issue">0</span>
            </summary>
            <div id="list-issue"></div>
        </details>

        <details open>
            <summary class="head-novel">
                <span>ğŸ“– ì†Œì„¤ (ë¦¬ë·°/ì¶”ì²œ)</span>
                <span class="cnt" id="cnt-novel">0</span>
            </summary>
            <div id="list-novel"></div>
        </details>

        <details>
            <summary class="head-chat">
                <span>ğŸ’¬ ì¡ë‹´ (ì¼ìƒ/í•™êµ)</span>
                <span class="cnt" id="cnt-chat">0</span>
            </summary>
            <div id="list-chat"></div>
        </details>
    </div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startStream() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const totalCount = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status'),
            progBar: document.getElementById('progress-bar'),
            progFill: document.getElementById('progress-fill'),
            result: document.getElementById('result-area'),
            lists: {
                issue: document.getElementById('list-issue'),
                novel: document.getElementById('list-novel'),
                chat: document.getElementById('list-chat')
            },
            cnts: {
                issue: document.getElementById('cnt-issue'),
                novel: document.getElementById('cnt-novel'),
                chat: document.getElementById('cnt-chat')
            }
        };

        if(!key || !startNo) return alert("API í‚¤ì™€ ì‹œì‘ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        // ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.result.style.display = 'block';
        ui.progBar.style.display = 'block';
        ui.progFill.style.width = '0%';
        Object.values(ui.lists).forEach(e => e.innerHTML = '');
        Object.values(ui.cnts).forEach(e => e.innerText = '0');
        
        let counts = { issue: 0, novel: 0, chat: 0 };
        const BATCH_SIZE = 5; // 5ê°œì”© ëŠì–´ì„œ ì²˜ë¦¬ (ì²´ê° ì†ë„ í–¥ìƒ í•µì‹¬)

        try {
            for (let i = 0; i < totalCount; i += BATCH_SIZE) {
                // ì´ë²ˆ í„´ì— ì²˜ë¦¬í•  ë²ˆí˜¸ë“¤ ê³„ì‚°
                const currentBatchSize = Math.min(BATCH_SIZE, totalCount - i);
                const currentStartNo = startNo - i;
                const batchIds = Array.from({length: currentBatchSize}, (_, idx) => currentStartNo - idx);
                
                ui.status.innerText = `ğŸ”„ ${i + 1}~${i + currentBatchSize}ë²ˆì§¸ ê¸€ ìˆ˜ì§‘ ë° ë¶„ì„ ì¤‘...`;

                // 1. ë³‘ë ¬ ìˆ˜ì§‘ (ë³¸ë¬¸ í¬í•¨)
                const fetchPromises = batchIds.map(async (no) => {
                    try {
                        const targetUrl = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${no}`;
                        const resp = await fetch(PROXY_URL + encodeURIComponent(targetUrl));
                        const html = await resp.text();
                        if(html.includes("ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤") || html.includes("ì‚­ì œëœ ê²Œì‹œê¸€")) return null;

                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        const title = doc.querySelector('.title_subject')?.innerText.trim();
                        // ë³¸ë¬¸ 100ì (ì†ë„ ìµœì í™”)
                        const body = doc.querySelector('.write_div')?.innerText.trim().substring(0, 100) || "";
                        
                        if(title) return { no, title, body };
                        return null;
                    } catch(e) { return null; }
                });

                const rawPosts = await Promise.all(fetchPromises);
                const posts = rawPosts.filter(p => p !== null);

                if (posts.length > 0) {
                    // 2. AI ë¶„ì„ (Gemini 2.5 Flash)
                    const MODEL_NAME = "gemini-2.0-flash-exp"; // 2.5 ëŒ€ì‘
                    
                    const prompt = `
                    Analyze these posts (Title+Body).
                    [Rules]
                    1. 'issue': ONLY for 'Novelpia' platform bugs, billing, or site policy complaints.
                    2. 'novel': Novel reviews, recs.
                    3. 'chat': School, Student council, Food, Daily life, Simple emotions.
                    
                    [Output]
                    JSON Only: {"results": {"ID": {"cat": "issue/novel/chat", "reason": "Korean short reason"}}}
                    
                    [Data]
                    ${posts.map(p => `ID:${p.no}|T:${p.title}|B:${p.body.replace(/\n/g, ' ')}`).join('\n')}
                    `;

                    const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const aiData = await aiResp.json();
                    
                    if (!aiData.error) {
                        const rawText = aiData.candidates[0].content.parts[0].text;
                        const resData = JSON.parse(rawText.replace(/```json|```/g, "").trim());

                        // 3. UI ì¦‰ì‹œ ê°±ì‹  (ìŠ¤íŠ¸ë¦¬ë° íš¨ê³¼)
                        posts.forEach(p => {
                            const info = resData.results[p.no] || { cat: 'chat', reason: '-' };
                            let cat = info.cat;
                            if(!['issue', 'novel', 'chat'].includes(cat)) cat = 'chat';

                            counts[cat]++;
                            
                            const div = document.createElement('div');
                            div.className = 'item';
                            div.innerHTML = `
                                <span class="item-no">${p.no}</span>
                                <a href="https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${p.no}" target="_blank" class="item-link">${p.title}</a>
                                <span class="item-reason">${info.reason}</span>
                            `;
                            ui.lists[cat].appendChild(div);
                        });

                        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                        ui.cnts.issue.innerText = counts.issue;
                        ui.cnts.novel.innerText = counts.novel;
                        ui.cnts.chat.innerText = counts.chat;
                    }
                }

                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                const progress = Math.min(100, ((i + BATCH_SIZE) / totalCount) * 100);
                ui.progFill.style.width = `${progress}%`;
            }

            ui.status.innerText = "âœ… ëª¨ë“  ë¶„ì„ ì™„ë£Œ!";

        } catch (e) {
            console.error(e);
            ui.status.innerText = `âŒ ì¤‘ë‹¨ë¨: ${e.message}`;
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>
</body>
</html>
