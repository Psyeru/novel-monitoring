<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë²¨ ë”¥ ëª¨ë‹ˆí„° v5 (Gemini Flash)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f4f7f6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #5a2df2; color: white; border: none; font-weight: bold; cursor: pointer; }
        #status { font-weight: bold; color: #5a2df2; margin: 15px 0; text-align: center; }
        #log { font-size: 11px; color: #666; background: #f9f9f9; padding: 10px; border-radius: 5px; max-height: 100px; overflow-y: auto; margin-bottom: 10px; }
        .result-card { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tag-site { background: #fff1f0; color: #d32f2f; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .tag-novel { background: #f0f5ff; color: #1a73e8; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ ë…¸ë²¨ ë”¥ ëª¨ë‹ˆí„° (ìµœì‹  Flash ì ìš©)</h2>
    <input type="password" id="apiKey" placeholder="Gemini API Key ì…ë ¥">
    <input type="number" id="lastNo" placeholder="ì‹œì‘ ë²ˆí˜¸ (ì˜ˆ: 11744085)">
    <input type="number" id="count" value="10">
    <button id="startBtn" onclick="run()">ìµœì‹  ëª¨ë¸ ë¶„ì„ ì‹œì‘</button>

    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <div id="log"></div>
    <div id="results"><h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3></div>
</div>

<script>
    const PROXY_URL = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function run() {
        const key = document.getElementById('apiKey').value;
        const lastNo = parseInt(document.getElementById('lastNo').value);
        const count = parseInt(document.getElementById('count').value);
        const logDiv = document.getElementById('log');
        const resDiv = document.getElementById('results');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('startBtn');

        if(!key || !lastNo) return alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

        btn.disabled = true;
        logDiv.innerHTML = "<b>[System]</b> í”„ë¡œì„¸ìŠ¤ ì‹œì‘...<br>";
        resDiv.innerHTML = "<h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>";
        let posts = [];

        try {
            // 1. ë°ì´í„° ìˆ˜ì§‘ ë‹¨ê³„
            for(let i = 0; i < count; i++) {
                const currentNo = lastNo - i;
                statusDiv.innerText = `ğŸ“¦ ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i+1}/${count})`;
                try {
                    const target = `https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=${currentNo}`;
                    const res = await fetch(PROXY_URL + encodeURIComponent(target));
                    const html = await res.text();
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    const title = doc.querySelector('.title_subject')?.innerText;
                    
                    if(title) {
                        posts.push({ id: currentNo, title });
                        logDiv.innerHTML += `<div>âœ… ${currentNo} ìˆ˜ì§‘ ì™„ë£Œ</div>`;
                    } else {
                        logDiv.innerHTML += `<div>âš ï¸ ${currentNo} ì¡´ì¬í•˜ì§€ ì•ŠìŒ</div>`;
                    }
                } catch(e) { logDiv.innerHTML += `<div>âŒ ${currentNo} ìˆ˜ì§‘ ì‹¤íŒ¨</div>`; }
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            // 2. AI ë¶„ì„ ë‹¨ê³„
            if(posts.length === 0) throw new Error("ë¶„ì„í•  ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
            statusDiv.innerText = "ğŸ§  ìµœì‹  Flash ëª¨ë¸ ë¶„ì„ ì¤‘...";
            
            // ëª¨ë¸ ëª…ì¹­: êµ¬ê¸€ APIì—ì„œ í˜„ì¬ ê°€ì¥ ì•ˆì •ì ì¸ ìµœì‹  Flash ëª¨ë¸ ê²½ë¡œì…ë‹ˆë‹¤.
            const MODEL_NAME = "gemini-2.0-flash-exp"; 
            
            const prompt = `Analyze these titles and categorize as 'site' (platform issues/news) or 'novel' (content/recs). 
            Response MUST be a JSON object ONLY.
            Format: {"ID": "category"}
            Titles:
            ${posts.map(p => `${p.id}: ${p.title}`).join('\n')}`;

            const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        response_mime_type: "application/json" // JSON ì „ìš© ëª¨ë“œ ê°•ì œ ì„¤ì •
                    }
                })
            });

            const data = await aiRes.json();
            if(data.error) throw new Error(data.error.message);

            // JSON í…ìŠ¤íŠ¸ íŒŒì‹±
            const aiRawContent = data.candidates[0].content.parts[0].text;
            const resultJson = JSON.parse(aiRawContent);

            posts.forEach(p => {
                const category = resultJson[p.id] || "novel";
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <span><b>#${p.id}</b> ${p.title.substring(0, 20)}...</span>
                    <span class="tag-${category}">${category === 'site' ? 'ğŸš¨ ì´ìŠˆ' : 'ğŸ“– ì†Œì„¤'}</span>
                `;
                resDiv.appendChild(card);
            });

            statusDiv.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";
        } catch(e) {
            console.error(e);
            statusDiv.innerText = "âŒ ì¤‘ë‹¨ë¨";
            logDiv.innerHTML += `<div style="color:red;"><b>ì˜¤ë¥˜:</b> ${e.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
