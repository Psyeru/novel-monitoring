<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°¤ëŸ¬ë¦¬ ì¸ì‚¬ì´íŠ¸ ëª¨ë‹ˆí„°</title>
    <style>
        :root { --primary: #5a2df2; --bg: #f8fafc; --surface: #ffffff; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-box { background: var(--surface); padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input { padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; flex: 1; font-size: 15px; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(90, 45, 242, 0.1); }
        
        button { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; width: 100%; transition: 0.2s; }
        button:hover { background: #4c24cc; transform: translateY(-1px); }
        button:disabled { background: #cbd5e1; cursor: wait; transform: none; }

        /* ìƒíƒœ ë° ì—ëŸ¬ ë©”ì‹œì§€ */
        #status-bar { margin-bottom: 15px; font-weight: 600; color: #4b5563; min-height: 24px; text-align: center; }
        .error-msg { color: #dc2626; background: #fee2e2; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 10px; display: none; }

        /* ìš”ì•½ ì¹´ë“œ */
        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; display: none; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); text-align: center; border: 1px solid #f1f5f9; }
        .card h3 { margin: 0 0 5px 0; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .card .value { font-size: 28px; font-weight: 800; color: #1e293b; }
        .card.issue .value { color: #ef4444; }

        /* ë¦¬í¬íŠ¸ í…Œì´ë¸” */
        .table-wrap { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: none; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8fafc; padding: 16px; text-align: left; font-weight: 700; color: #475569; border-bottom: 1px solid #e2e8f0; }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f8fafc; }

        /* ë±ƒì§€ */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 11px; }
        .bg-issue { background: #fee2e2; color: #991b1b; }
        .bg-novel { background: #dbeafe; color: #1e40af; }
        .bg-chat { background: #f3f4f6; color: #374151; }
        
        .post-link { text-decoration: none; color: #1e293b; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 380px; }
        .post-link:hover { color: var(--primary); text-decoration: underline; }
        .reason-text { font-size: 13px; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; margin-bottom:20px;">
        <h2 style="margin:0; color:#1e293b;">ğŸ“Š ê°¤ëŸ¬ë¦¬ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h2>
    </div>

    <div class="control-box">
        <div class="input-row">
            <input type="password" id="apiKey" placeholder="Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="input-row">
            <input type="number" id="startNo" placeholder="ì‹œì‘ ê²Œì‹œë¬¼ ë²ˆí˜¸ (ì˜ˆ: 11744100)">
            <input type="number" id="count" value="20" placeholder="ê°œìˆ˜ (ìµœëŒ€ 50)" style="flex: 0.3;">
        </div>
        <button id="btnRun" onclick="startAnalysis()">ğŸš€ ê³ ì† ë¶„ì„ ì‹œì‘</button>
        <div id="errorBox" class="error-msg"></div>
    </div>

    <div id="status-bar">ì¤€ë¹„ ì™„ë£Œ</div>

    <div class="summary-grid" id="summaryPanel">
        <div class="card">
            <h3>ë¶„ì„ëœ ê¸€</h3>
            <div class="value" id="valTotal">-</div>
        </div>
        <div class="card issue">
            <h3>ì´ìŠˆ ê°ì§€</h3>
            <div class="value" id="valIssue">-</div>
        </div>
        <div class="card">
            <h3>ì£¼ìš” í‚¤ì›Œë“œ</h3>
            <div class="value" id="valKeyword" style="font-size: 20px;">-</div>
        </div>
    </div>

    <div class="table-wrap" id="reportPanel">
        <table>
            <thead>
                <tr>
                    <th width="10%">ë²ˆí˜¸</th>
                    <th width="12%">ë¶„ë¥˜</th>
                    <th width="48%">ì œëª©</th>
                    <th width="30%">AI ë¶„ì„ ì½”ë©˜íŠ¸</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. í”„ë¡ì‹œ ì„¤ì • (ì‚¬ìš©ì Worker ì£¼ì†Œ)
    const PROXY_BASE = "https://bold-snowflake-1782.syeru1209.workers.dev/?url=";

    async function startAnalysis() {
        const key = document.getElementById('apiKey').value.trim();
        const startNo = parseInt(document.getElementById('startNo').value);
        const count = parseInt(document.getElementById('count').value);
        
        const ui = {
            btn: document.getElementById('btnRun'),
            status: document.getElementById('status-bar'),
            error: document.getElementById('errorBox'),
            summary: document.getElementById('summaryPanel'),
            report: document.getElementById('reportPanel'),
            tbody: document.getElementById('resultBody'),
            vTotal: document.getElementById('valTotal'),
            vIssue: document.getElementById('valIssue'),
            vKeyword: document.getElementById('valKeyword')
        };

        if(!key || !startNo) {
            alert("API í‚¤ì™€ ì‹œì‘ ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // UI ì´ˆê¸°í™”
        ui.btn.disabled = true;
        ui.error.style.display = 'none';
        ui.summary.style.display = 'none';
        ui.report.style.display = 'none';
        ui.tbody.innerHTML = '';
        ui.status.innerText = "âš¡ ê²Œì‹œíŒ ëª©ë¡ ìŠ¤ìº” ì¤‘... (1ì´ˆ ì†Œìš”)";

        try {
            // 2. [ì†ë„ ê°œì„ ] ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ í•œ ë²ˆë§Œ í˜¸ì¶œí•´ì„œ ì œëª© 50ê°œ ê¸ì–´ì˜¤ê¸°
            const targetUrl = `https://gall.dcinside.com/mgallery/board/lists/?id=genrenovel&page=1`;
            const proxyUrl = PROXY_BASE + encodeURIComponent(targetUrl);
            
            const resp = await fetch(proxyUrl);
            if (!resp.ok) throw new Error("í”„ë¡ì‹œ ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");
            const html = await resp.text();
            
            // 3. HTML íŒŒì‹±
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const rows = Array.from(doc.querySelectorAll('.ub-content.us-post'));
            
            let collectedPosts = [];
            
            rows.forEach(row => {
                const numCell = row.querySelector('.gall_num');
                const titleCell = row.querySelector('.gall_tit a');
                
                if (numCell && titleCell) {
                    const no = parseInt(numCell.innerText);
                    const title = titleCell.innerText.trim();
                    
                    // ì‹œì‘ ë²ˆí˜¸ ì´í•˜ì´ë©´ì„œ ìœ íš¨í•œ ê¸€ë§Œ ìˆ˜ì§‘
                    if (!isNaN(no) && no <= startNo) {
                        collectedPosts.push({ no, title });
                    }
                }
            });

            // ê°œìˆ˜ ìë¥´ê¸°
            collectedPosts = collectedPosts.slice(0, count);

            if (collectedPosts.length === 0) throw new Error(`${startNo}ë²ˆ ì´í•˜ì˜ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (í˜ì´ì§€ê°€ ë„˜ì–´ê°”ì„ ìˆ˜ ìˆìŒ)`);

            // 4. AI ë¶„ì„ (Gemini 1.5 Flash ì‚¬ìš© - ê°€ì¥ ì•ˆì •ì )
            ui.status.innerText = `ğŸ§  ê²Œì‹œë¬¼ ${collectedPosts.length}ê°œ ì •ë°€ ë¶„ì„ ì¤‘...`;

            // ì¤‘ìš”: 2.0-flash-exp ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ 1.5-flash ì‚¬ìš© (ì„±ëŠ¥ ì°¨ì´ ë¯¸ë¯¸, ì•ˆì •ì„± ìµœìš°ì„ )
            const MODEL = "gemini-1.5-flash"; 
            
            const prompt = `
            Analyze these web novel community titles.
            
            Task:
            1. Classify each title into: 'issue' (Controversy, Bug, Complaints), 'novel' (Story discussion, Reviews), 'chat' (General questions).
            2. Provide a short reason in Korean.
            3. Extract 1 main keyword for the overall vibe.

            Output Format: JSON ONLY. No markdown.
            {
                "keyword": "MainKeyword",
                "results": {
                    "POST_NUMBER": {"cat": "issue/novel/chat", "reason": "Short reason"}
                }
            }

            Data:
            ${collectedPosts.map(p => `${p.no}: ${p.title}`).join('\n')}
            `;

            const aiResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const aiData = await aiResp.json();
            
            // [ì—ëŸ¬ ë°©ì§€] AI ì‘ë‹µ ê²€ì¦
            if (aiData.error) throw new Error(`API ì˜¤ë¥˜: ${aiData.error.message}`);
            if (!aiData.candidates || !aiData.candidates[0].content) throw new Error("AIê°€ ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì•ˆì „ í•„í„° ë˜ëŠ” ê³¼ë¶€í•˜)");

            const rawText = aiData.candidates[0].content.parts[0].text;
            // JSONë§Œ ì¶”ì¶œ (```json ì œê±°)
            const jsonStr = rawText.replace(/```json|```/g, "").trim();
            const resultData = JSON.parse(jsonStr);

            // 5. ê²°ê³¼ ë Œë”ë§
            let issueCount = 0;
            
            collectedPosts.forEach(post => {
                const info = resultData.results[post.no] || { cat: 'chat', reason: '-' };
                if (info.cat === 'issue') issueCount++;

                const tr = document.createElement('tr');
                
                // ë±ƒì§€ ìŠ¤íƒ€ì¼
                let badgeHtml = '';
                if(info.cat === 'issue') badgeHtml = '<span class="badge bg-issue">ğŸš¨ ì´ìŠˆ</span>';
                else if(info.cat === 'novel') badgeHtml = '<span class="badge bg-novel">ğŸ“– ì†Œì„¤</span>';
                else badgeHtml = '<span class="badge bg-chat">ğŸ’¬ ì¡ë‹´</span>';

                tr.innerHTML = `
                    <td style="color:#64748b;">${post.no}</td>
                    <td>${badgeHtml}</td>
                    <td><a href="[https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=$](https://gall.dcinside.com/mgallery/board/view/?id=genrenovel&no=$){post.no}" target="_blank" class="post-link">${post.title}</a></td>
                    <td class="reason-text">${info.reason}</td>
                `;
                ui.tbody.appendChild(tr);
            });

            // ìš”ì•½ íŒ¨ë„ ì—…ë°ì´íŠ¸
            ui.vTotal.innerText = collectedPosts.length;
            ui.vIssue.innerText = issueCount;
            ui.vKeyword.innerText = resultData.keyword || "N/A";

            ui.summary.style.display = 'grid';
            ui.report.style.display = 'block';
            ui.status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ!";

        } catch (e) {
            console.error(e);
            ui.status.innerText = "âŒ ì¤‘ë‹¨ë¨";
            ui.error.innerText = `ì˜¤ë¥˜ ë°œìƒ: ${e.message}`;
            ui.error.style.display = 'block';
        } finally {
            ui.btn.disabled = false;
        }
    }
</script>

</body>
</html>
